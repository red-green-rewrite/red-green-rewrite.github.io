<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Red, Green, Rewrite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Red, Green, Rewrite">
<meta property="og:url" content="http://red-green-rewrite.github.io/page/7/index.html">
<meta property="og:site_name" content="Red, Green, Rewrite">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Milosz Krajewski">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Red, Green, Rewrite" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-94127827-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Red, Green, Rewrite</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://red-green-rewrite.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Maze-generator-again-but-this-time-with-Scala-js" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/26/Maze-generator-again-but-this-time-with-Scala-js/" class="article-date">
  <time datetime="2016-09-26T18:44:57.000Z" itemprop="datePublished">2016-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/26/Maze-generator-again-but-this-time-with-Scala-js/">Maze generator again this time with Scala.js</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Quick-links"><a href="#Quick-links" class="headerlink" title="Quick links"></a>Quick links</h2><ul>
<li><a href="/2016/09/14/Maze-generator-with-Fable/">Randomized depth-first search</a></li>
<li><a href="/2016/09/15/Shaking-maze-generator/">Randomized depth-first search with stack shaking</a></li>
<li><a href="/2016/09/26/Maze-generator-again-but-this-time-with-Scala-js/">Random spanning tree with Prim’s algorithm</a></li>
<li><a href="/2016/10/06/Kruskal-Kotlin-and-Hex-Tiles/">Random spanning tree using Kruskal’s algorithm</a></li>
<li><a href="/2016/10/30/Kruskal-DFS-hybrid-with-reduced-branching-factor/">Hybrid of depth-first search and Kruskal’s algorithm</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MiloszKrajewski/scalajs-mazigeen">Source code</a></li>
<li><a href="/scalajs-mazigeen/index.html">Online demo</a></li>
</ul>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>So last week I was doing <a href="/2016/09/14/Maze-generator-with-Fable/">maze generator using randomizes depth first search</a> with <a target="_blank" rel="noopener" href="https://fable-compiler.github.io/">Fable</a>. Then, to increase “branching factor” I’ve added <a href="/2016/09/15/Shaking-maze-generator/">stack shaking</a>. Today it’s time for slightly different approach.</p>
<p>As I said before this task was just kind of excuse technologies which I never used before. So far, I managed to scratch the surface of <a href="/2016/09/14/Maze-generator-with-Fable/">Fable</a>, <a target="_blank" rel="noopener" href="https://webpack.github.io/">Webpack</a> and <a target="_blank" rel="noopener" href="https://github.com/Matt-Esch/virtual-dom">VirtualDOM</a>. For performance reasons VirtualDOM got replaced by <a target="_blank" rel="noopener" href="http://projects.calebevans.me/jcanvas/">jCanvas</a>.</p>
<p>So, today’s new tech is <a target="_blank" rel="noopener" href="https://www.scala-js.org/">Scala.js</a>! Yay! I’m a big fan of <a target="_blank" rel="noopener" href="http://www.scala-lang.org/">Scala</a> although I did not have a chance to use it for anything bigger than HelloWorld so far. I’m not saying that this task is much bigger, but at least it does <em>something</em>. Anyway, <em>Scala.js</em>, here I come!</p>
<h2 id="Setting-environement-up"><a href="#Setting-environement-up" class="headerlink" title="Setting environement up"></a>Setting environement up</h2><p>It was not trivial to set up the environment. I actually struggled with the environment for couple of days before I managed to make it run. Making it work with <em>Webpack</em> was painful, especially because I’m not proficient in either of those. Apparently, <em>Scala.js</em> does <strong>not</strong> produce modular JavaScript and expects everything to be in <code>global</code>, so instead of:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jquery = <span class="built_in">require</span>(<span class="string">&quot;jquery&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> scalajs = <span class="built_in">require</span>(<span class="string">&quot;scalajs&quot;</span>)(jquery);</span><br></pre></td></tr></table></figure>

<p>we need this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// not actual code!</span></span><br><span class="line"><span class="keyword">var</span> jquery = <span class="built_in">require</span>(<span class="string">&quot;jquery&quot;</span>);</span><br><span class="line"><span class="built_in">global</span>.jQuery = jquery;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;scalajs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> scalajs = <span class="built_in">global</span>.scalajs;</span><br></pre></td></tr></table></figure>

<p>Quite nasty. Maybe there is easier way, but it wasn’t obvious. If you know how to do it better let me know, but if you have similar problem you can use my <a target="_blank" rel="noopener" href="https://github.com/MiloszKrajewski/template-scalajs-sbt-webpack">generic empty project</a>, but be aware - is highly opinionated.</p>
<p>Let’s do some coding now…</p>
<h2 id="The-algorithm"><a href="#The-algorithm" class="headerlink" title="The algorithm"></a>The algorithm</h2><p>Most of maze generation algorithms on <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Maze_generation_algorithm">Wikipedia</a> are building spanning trees for graphs where vertices are representing <em>rooms</em> and edges are representing <em>doors</em>. </p>
<p>Last week’s approach was <a href="/2016/09/14/Maze-generator-with-Fable/">randomized depth first search</a> now it’s time for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Prim%27s_algorithm">Prim’s algorithm</a>.</p>
<p><em>Prim’s algorithm</em> is building <em>minimum</em> spanning tree. We don’t need minimum, we need <em>random</em> spanning tree (that’s what <em>randomized depth first search</em> was doing). To achieve that, we can assign random weights to <em>edges</em> so <em>minimum</em> spanning tree will actually become <em>random</em> spanning tree. I didn’t but it could be actually interesting to play with different random distributions.</p>
<p>Let’s start with modelling the <code>Node</code> (or <em>Vertex</em>) and <code>Edge</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Node</span>[<span class="type">E</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">edges</span></span>: <span class="type">Seq</span>[<span class="type">E</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Edge</span>[<span class="type">N</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">A</span></span>: <span class="type">N</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">B</span></span>: <span class="type">N</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weight</span></span>: <span class="type">Double</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you don’t know what <code>trait</code> is, you can think about this as <code>interface</code> from Java or C#. It is a little bit more complicated than that, but it is good enough aproximation, at least for this model. So, <code>Node</code> (<em>vertex</em>) has a sequence (list?) of <em>edges</em> going out, and <code>Edge</code> has two <em>nodes</em>, beginning and end, plus <em>weight</em>. That’s what <em>Prim’s algorithm</em> needs to work.</p>
<p>Actually, <code>Edge.weight</code> does not need to be modelled as <code>Double</code>. It could be declared as type parameter, let’s say <code>W</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Edge</span>[<span class="type">N</span>, <span class="type">W</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">A</span></span>: <span class="type">N</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">B</span></span>: <span class="type">N</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weight</span></span>: <span class="type">W</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In such case implementation of <em>Prim’s algorithm</em> would need a way to compare two <code>W</code>s (<code>Ordering[W]</code> or <code>IComparator&lt;W&gt;</code>) but, for simplicity, I’ve implemented it as <code>Double</code> so let’s leave it like this.</p>
<p>So, let’s start with Prim’s solver:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prim</span>[<span class="type">N</span> &lt;: <span class="type">Node</span>[<span class="type">E</span>], <span class="title">E</span> <span class="title">&lt;</span></span>: <span class="type">Edge</span>[<span class="type">N</span>]](<span class="keyword">val</span> node: <span class="type">N</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So, what we have is a generic class which take two types <code>N</code> and <code>E</code> where <em>N</em> is <em>Node of E</em> and <em>E</em> is <em>Edge of N</em>. We are just making sure types are consistent.</p>
<p>How Prim’s algorithm work? It starts with a <em>single node</em> and marks it as visisted. On every step it choses an <em>edge with minimum weight</em> which connects <em>visited node</em> to <em>not visited node</em>. </p>
<p>That’s kind of it and it can be derived from the name: <em>minimum spanning tree</em>. We know that every node needs to be in solution (the word: <em>spanning</em>), we don’t take edges with both ends already visited as we don’t want <em>cycles</em> (the word: <em>tree</em>), we don’t take edges with both ends not visited as it could create <em>disjoint graph</em> (the word <em>spanning</em> again, and <em>tree</em> but not <em>forest</em>). We also take lightests <em>edge</em> available as we need it to be <em>minimum</em>. Don’t quote this though, it is not formal proof of correctness :) </p>
<p>So this description suggests the solution needs: <em>set of visited nodes</em> and <em>ordered queue of edges</em>. </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.collection.&#123;mutable =&gt; c&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prim</span>[<span class="type">N</span> &lt;: <span class="type">Node</span>[<span class="type">E</span>], <span class="title">E</span> <span class="title">&lt;</span></span>: <span class="type">Edge</span>[<span class="type">N</span>]](<span class="keyword">val</span> node: <span class="type">N</span>) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> ordering: <span class="type">Ordering</span>[<span class="type">E</span>] = <span class="type">Ordering</span>.by(e =&gt; -e.weight)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> queue = c.<span class="type">PriorityQueue</span>.empty(ordering)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> visited = c.<span class="type">HashSet</span>.empty[<span class="type">N</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nothing fancy. We have <em>set of visited nodes</em> (<code>visited</code>), we have <em>ordered queue of  edges</em> (<code>queue</code>). To make it <em>ordered</em> we use <code>PriorityQueue</code> provide a way to compare <em>edges</em> (<code>ordering</code>) by comparing <em>weights</em>. As <code>PriorityQueue</code> puts heaviest first we need to reverse it. I used <code>-weight</code> but <code>Ordering</code> has actually a method <code>reverse</code> (I just found it out too late).</p>
<p>As I said last week I like one-liners to remove clutter from business code, so let’s define few for this task:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span></span>(node: <span class="type">N</span>) = visited.contains(node)</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">mark</span></span>(node: <span class="type">N</span>) = visited.add(node)</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">dequeue</span></span>(): <span class="type">Option</span>[<span class="type">E</span>] = <span class="keyword">if</span> (queue.isEmpty) <span class="type">None</span> <span class="keyword">else</span> <span class="type">Some</span>(queue.dequeue())</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">fanout</span></span>(node: <span class="type">N</span>) = queue.enqueue(node.edges: _*)</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">visit</span></span>(node: <span class="type">N</span>) = &#123; mark(node); fanout(node) &#125;</span><br></pre></td></tr></table></figure>

<p>We can <code>test</code> the <em>node</em> if it was <em>visited</em>, we can <code>mark</code> the <em>node</em> as such, we <code>dequeue</code> the edge from <em>queue of lightests edges</em>, and we can <code>fanout</code> from given <em>node</em> by adding all outgoing <em>edges</em> to the <em>queue of lightests edges</em>. As last one we have full definition what a <em>visit</em> means, it is <em>marking</em> and then <em>fanning out</em> (I use this word wrongly, don’t I?).</p>
<p>Two non-trivial things. My <em>reimplementation</em> of <code>deqeue</code> returns <code>Option[E]</code>. I actually still don’t belive that there is no <em>dequeue</em> returning <em>option</em> on <code>PriorirtyQueue</code>. I missed it, right? For those who don’t know what I’m whining about let me explain. In functional languages, and Scala claims to be one, exceptions are for trully exceptional situations like, “cosmic ray just hit the CPU”. The expected situations should be handled by type system, and <code>dequeue</code> is perfect example of it: queue can be empty and when you try to get something from it the result should be “nada, come back later”. And that’s exactly what <code>Option</code> type gives us.</p>
<p>The other thing (Am I digressing all the time?) is the <em>splat</em> operator (<code>:_*</code>) in <code>fanout</code>. I actually spent good 15 minutes looking for it as my google-foo failed me. Apparently, <code>enqueue</code> takes multiple arguments (<code>varargs</code> in Java or <code>params</code> in C#) but all I had was a sequence (one argument). C# deals with that implicitly but Scala requires this… thing. I’m actually not sure what it is, maybe something like static cast in F# (<code>:&gt;</code>) with wilcard (<code>_</code>) as a type? Anyway, it works as expected.</p>
<p>So we have mini language for domain of Prim’s algorithm. Let’s do the algorithm then. If it was about solving the problem I would use a <code>for</code> loop (<code>while</code>, <code>foreach</code> whatever). If it was a language with lazy generators or coroutines I would reuse the <code>for</code> loop with <code>yield</code>, but Scala does not have lazy generators. I guess “yet”, as every language is getting them (<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/yield">JavaScript</a> and <a target="_blank" rel="noopener" href="https://github.com/Kotlin/kotlin-coroutines">Kotlin</a>). Anyway, that’s why we need to store the state (<code>visited</code> and <code>queue</code>) as class members and not inside a generator function.</p>
<p>Let’s go: </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">Option</span>[<span class="type">E</span>] = &#123;</span><br><span class="line">    dequeue().flatMap &#123; edge =&gt;</span><br><span class="line">        (test(edge.<span class="type">A</span>), test(edge.<span class="type">B</span>)) <span class="keyword">match</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> (<span class="literal">true</span>, <span class="literal">true</span>) =&gt; next()</span><br><span class="line">            <span class="keyword">case</span> (<span class="literal">false</span>, <span class="literal">true</span>) =&gt; visit(edge.<span class="type">A</span>); <span class="type">Some</span>(edge)</span><br><span class="line">            <span class="keyword">case</span> (<span class="literal">true</span>, <span class="literal">false</span>) =&gt; visit(edge.<span class="type">B</span>); <span class="type">Some</span>(edge)</span><br><span class="line">            <span class="keyword">case</span> _ =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">&quot;Not a valid graph&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So this method potentially returns next edge. <em>Potentially</em> as we may run out of edges and that’s the stop condition for algorithm. So it takes next edge (<code>dequeue</code>) and if there are no more edges it just returns <code>None</code> and that’s it (<code>flatMap</code>). If there was an edge still available it tests both ends (<code>test(edge.X)</code>). If both are already visited (<code>true, true</code>) this edge is not good let’s take <code>next</code> one. If only one of them is visited (<code>true, false</code> and <code>false, true</code>) mark <code>visit</code> the <em>unvisited</em> one and return this edge (<code>Some(edge)</code>). If both of them seems to be not visited yet something went horribly wrong (cosmic ray?) and it’s time to panic (<code>throw</code>).</p>
<p> Nice.</p>
<h2 id="The-domain"><a href="#The-domain" class="headerlink" title="The domain"></a>The domain</h2><p>We have generic Prim’s algorithm implemented so far but we need to use to solve very specific problem. Building a maze. So let’s deal with the domain.</p>
<p>Let’s start with <code>Point</code> with geometric coordinates:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">x: <span class="type">Int</span>, y: <span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>a <code>Room</code> which is a <code>Node</code> (has trait or implements interface) in a graph:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span>(<span class="params">val position: <span class="type">Point</span></span>) <span class="keyword">extends</span> <span class="title">Node</span>[<span class="type">Door</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> edges = c.<span class="type">ArrayBuffer</span>.empty[<span class="type">Door</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(other: <span class="type">Room</span>, weight: <span class="type">Double</span>) = &#123;</span><br><span class="line">        <span class="keyword">val</span> door = <span class="keyword">new</span> <span class="type">Door</span>(<span class="keyword">this</span>, other, weight)</span><br><span class="line">        edges += door</span><br><span class="line">        other.edges += door</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It additionally, defines <code>add</code> method (I should have named it <code>connect</code> I guess) which creates <em>door</em> connecting two <em>rooms</em>.  I’m actually quite impressed how flexible scala is in this respect. <code>Node</code> trait defines <code>edges</code> as <code>def edges: Seq[E]</code> (a method returning sequence) but <code>Room</code> class implements it as <code>val edges: ArrayBuffer[Door]</code> (a field holding mutable collection of <code>Door</code>). No implicit interface implementation or shadowing was needed, it just worked.</p>
<p>The last one is <code>Door</code> (or <em>edge</em>):</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Door</span>(<span class="params">val <span class="type">A</span>: <span class="type">Room</span>, val <span class="type">B</span>: <span class="type">Room</span>, val weight: <span class="type">Double</span></span>) <span class="keyword">extends</span> <span class="title">Edge</span>[<span class="type">Room</span>]</span></span><br></pre></td></tr></table></figure>

<p>The last thing we need for domain is the way to create the graph:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span>(<span class="params">size: <span class="type">Point</span>, random: (</span>) <span class="title">=&gt;</span> <span class="title">Double</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> rooms = <span class="type">Array</span>.tabulate(size.x, size.y) &#123; (x, y) =&gt; <span class="keyword">new</span> <span class="type">Room</span>(<span class="type">Point</span>(x, y)) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">at</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Room</span> = rooms(x)(y)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">connect</span></span>(room: <span class="type">Room</span>, other: <span class="type">Room</span>, weight: <span class="type">Double</span>) = room.add(other, weight)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (x &lt;- <span class="number">0</span> until size.x; y &lt;- <span class="number">0</span> until size.y) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span>) connect(at(x, y), at(x - <span class="number">1</span>, y), random())</span><br><span class="line">        <span class="keyword">if</span> (y &gt; <span class="number">0</span>) connect(at(x, y), at(x, y - <span class="number">1</span>), random())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">room00</span> </span>= rooms(<span class="number">0</span>)(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Model</code> object takes a size of the <em>world</em> and <em>random number generator</em> (so we can use any generator we want). It creates two dimensional array of <em>rooms</em> (<code>Array.tabulate</code>) initializes it (<code>new Room(x, y)</code>). If provides a function get <em>room</em> object at given location (<code>at(...): Room</code>) and <code>connect</code> two rooms. Both methods are kind of overkill but make the business logic (the <code>for</code> loop) clutter-free. We also export starting room (<code>room00</code>). If you really wanted to you could implement this <code>Model</code> class as a single function: <code>createModel: (Point, () =&gt; Double) =&gt; Room</code>, but old habits die hard.</p>
<p>So, once again, the domain is implemented. All what is left is the UI or presentation layer.</p>
<h2 id="The-presentation-layer"><a href="#The-presentation-layer" class="headerlink" title="The presentation layer"></a>The presentation layer</h2><p>I won’t be describing UI in details, so please refer to <a target="_blank" rel="noopener" href="https://github.com/MiloszKrajewski/scalajs-mazigeen">Github</a> for actual sources. In general it goes like this…</p>
<p>We have some constants:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> <span class="type">WORLD_SIZE</span> = <span class="type">Point</span>(<span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> <span class="type">ROOM_COLOR</span> = <span class="string">&quot;#fff&quot;</span></span><br><span class="line"><span class="keyword">val</span> <span class="type">DOOR_COLOR</span> = <span class="string">&quot;#eee&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> <span class="type">ROOM_SIZE</span> = <span class="number">6</span></span><br><span class="line"><span class="keyword">val</span> <span class="type">DOOR_SIZE</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>defining size of the <em>universe</em> (<code>WORLD_SIZE</code>), some colors, dimensions in pixels (<code>DOOR_SIZE</code> and <code>ROOM_SIZE</code>), and helper functions: </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">toPixel</span></span>(v: <span class="type">Int</span>): <span class="type">Int</span> = v * <span class="type">ROOM_SIZE</span> + (v + <span class="number">1</span>) * <span class="type">DOOR_SIZE</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">toPixel</span></span>(p: <span class="type">Point</span>): <span class="type">Point</span> = <span class="type">Point</span>(toPixel(p.x), toPixel(p.y))</span><br></pre></td></tr></table></figure>

<p>to translate between <em>room</em> location to pixel position (<code>toPixel</code>).  </p>
<p>We need to intialize canvas:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>() = &#123;</span><br><span class="line">    <span class="keyword">val</span> size = toPixel(<span class="type">WORLD_SIZE</span>)</span><br><span class="line">    <span class="keyword">val</span> (width, height) = (size.x, size.y)</span><br><span class="line">    <span class="keyword">val</span> view = <span class="string">s&quot;0 0 <span class="subst">$width</span> <span class="subst">$height</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    jQuery(<span class="string">&quot;#canvas&quot;</span>)</span><br><span class="line">            .attr(<span class="string">&quot;width&quot;</span>, width).attr(<span class="string">&quot;height&quot;</span>, height)</span><br><span class="line">            .attr(<span class="string">&quot;viewbox&quot;</span>, view).attr(<span class="string">&quot;viewport&quot;</span>, view)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> context =</span><br><span class="line">        document.getElementById(<span class="string">&quot;canvas&quot;</span>).asInstanceOf[<span class="type">Canvas</span>]</span><br><span class="line">                .getContext(<span class="string">&quot;2d&quot;</span>).asInstanceOf[<span class="type">CanvasRenderingContext2D</span>]</span><br><span class="line"></span><br><span class="line">    jQuery(<span class="string">&quot;#restart&quot;</span>).click((e: <span class="type">Any</span>) =&gt; restart(context, width, height))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>by setting <code>width</code>, <code>height</code> and <code>viewbox</code>, and attach <code>restart</code> method as a handler for <code>click</code> event on <em>Restart</em> button. </p>
<p>Restart shuts down previous animation (<code>shutdown</code>), sets up the drawing context of the canvas (<code>context</code>), initializes the <code>model</code> and <code>algorithm</code> and starts animation on interval (<code>window.setInterval</code>). </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> handle: <span class="type">Option</span>[<span class="type">Int</span>] = <span class="type">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restart</span></span>(context: <span class="type">CanvasRenderingContext2D</span>, width: <span class="type">Int</span>, height: <span class="type">Int</span>) = &#123;</span><br><span class="line">    shutdown()</span><br><span class="line"></span><br><span class="line">    context.clearRect(<span class="number">0</span>, <span class="number">0</span>, width, height)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> model = <span class="keyword">new</span> <span class="type">Model</span>(<span class="type">WORLD_SIZE</span>, <span class="type">Random</span>.nextDouble)</span><br><span class="line">    <span class="keyword">val</span> algorithm = <span class="keyword">new</span> <span class="type">Prim</span>[<span class="type">Room</span>, <span class="type">Door</span>](model.room00)</span><br><span class="line"></span><br><span class="line">    handle = <span class="type">Some</span>(window.setInterval(() =&gt; step(algorithm, context), <span class="number">0</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shutdown</span></span>() = &#123;</span><br><span class="line">    handle.foreach(window.clearInterval)</span><br><span class="line">    handle = <span class="type">None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We will also need to actually draw <em>rooms</em> and <em>doors</em>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawRoom</span></span>(context: <span class="type">CanvasRenderingContext2D</span>, room: <span class="type">Room</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> p = toPixel(room.position)</span><br><span class="line">    context.fillStyle = <span class="type">ROOM_COLOR</span></span><br><span class="line">    context.fillRect(p.x, p.y, <span class="type">ROOM_SIZE</span>, <span class="type">ROOM_SIZE</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawDoor</span></span>(context: <span class="type">CanvasRenderingContext2D</span>, door: <span class="type">Door</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> a = toPixel(door.<span class="type">A</span>.position)</span><br><span class="line">    <span class="keyword">val</span> b = toPixel(door.<span class="type">B</span>.position)</span><br><span class="line">    <span class="keyword">val</span> o = <span class="type">ROOM_SIZE</span> / <span class="number">2</span></span><br><span class="line">    context.strokeStyle = <span class="type">DOOR_COLOR</span></span><br><span class="line">    context.lineWidth = <span class="type">ROOM_SIZE</span></span><br><span class="line">    context.beginPath()</span><br><span class="line">    context.moveTo(a.x + o, a.y + o)</span><br><span class="line">    context.lineTo(b.x + o, b.y + o)</span><br><span class="line">    context.closePath()</span><br><span class="line">    context.stroke()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The last part is the single step of animation, which takes <code>algorithm</code> and drawing <code>context</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step</span></span>(algorithm: <span class="type">Prim</span>[<span class="type">Room</span>, <span class="type">Door</span>], context: <span class="type">CanvasRenderingContext2D</span>) = &#123;</span><br><span class="line">    algorithm.next() <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">None</span> =&gt; shutdown()</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Some</span>(door) =&gt; </span><br><span class="line">            drawDoor(context, door)</span><br><span class="line">            drawRoom(context, door.<span class="type">A</span>)</span><br><span class="line">            drawRoom(context, door.<span class="type">B</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If next <em>edge</em>/<em>door</em> (<code>algorithm.next()</code>) cannot be found (<code>case None</code>) then animation is stopped (<code>shutdown()</code>) otherwise it just draws <em>door</em> and two <em>rooms</em>. </p>
<p>And yet again: that’s it.</p>
<h2 id="Online-demo"><a href="#Online-demo" class="headerlink" title="Online demo"></a>Online demo</h2><p>You can get your own copy from <a target="_blank" rel="noopener" href="https://github.com/MiloszKrajewski/scalajs-mazigeen">Github</a> or you can just watch it working <a href="http://red-green-rewrite.github.io/scalajs-mazigeen/index.html">here</a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I really loved the fact that I had access to Scala collections and they worked as expected. It gives you this warm feeling when you can just use <code>PriorirtyQueue</code> of the shelf. The code Scala.js produces is not nearly as readable as Fable gives us. Is actually pretty awful with horribly mangled names. That’s why I was struggling to understand why it does not see jQuery and how to make it work with Webpack. I do now, but it took me a while.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://red-green-rewrite.github.io/2016/09/26/Maze-generator-again-but-this-time-with-Scala-js/" data-id="ckthjm5yk001iz4jbeb0tb8m0" class="article-share-link">Share</a>
      
        <a href="http://red-green-rewrite.github.io/2016/09/26/Maze-generator-again-but-this-time-with-Scala-js/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/maze/" rel="tag">maze</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scala/" rel="tag">scala</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scala-js/" rel="tag">scala.js</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/6/">&amp;laquo; __(&#39;prev&#39;)</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/8/">__(&#39;next&#39;) &amp;raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/" rel="tag">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fable/" rel="tag">fable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fsharp/" rel="tag">fsharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/functional/" rel="tag">functional</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kata/" rel="tag">kata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-js/" rel="tag">kotlin.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maze/" rel="tag">maze</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/" rel="tag">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala-js/" rel="tag">scala.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/state-machine/" rel="tag">state-machine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/" rel="tag">tree</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/csharp/" style="font-size: 14px;">csharp</a> <a href="/tags/design/" style="font-size: 12px;">design</a> <a href="/tags/fable/" style="font-size: 14px;">fable</a> <a href="/tags/fsharp/" style="font-size: 18px;">fsharp</a> <a href="/tags/functional/" style="font-size: 12px;">functional</a> <a href="/tags/kata/" style="font-size: 10px;">kata</a> <a href="/tags/kotlin/" style="font-size: 14px;">kotlin</a> <a href="/tags/kotlin-js/" style="font-size: 12px;">kotlin.js</a> <a href="/tags/maze/" style="font-size: 16px;">maze</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/scala-js/" style="font-size: 10px;">scala.js</a> <a href="/tags/state-machine/" style="font-size: 10px;">state-machine</a> <a href="/tags/tree/" style="font-size: 10px;">tree</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/10/Saving-New-York-with-F-Bloxorz-and-John-McClane/">Saving New York with F#, Bloxorz and John McClane</a>
          </li>
        
          <li>
            <a href="/2017/03/20/Further-than-SAM/">Further than SAM</a>
          </li>
        
          <li>
            <a href="/2017/03/12/You-are-better-off-with-SAM/">You are better off with SAM</a>
          </li>
        
          <li>
            <a href="/2016/10/30/Kruskal-DFS-hybrid-with-reduced-branching-factor/">Kruskal/DFS hybrid with reduced branching factor</a>
          </li>
        
          <li>
            <a href="/2016/10/06/Kruskal-Kotlin-and-Hex-Tiles/">Kruskal, Kotlin, and Hex Tiles</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Milosz Krajewski<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'red-green-rewrite';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>