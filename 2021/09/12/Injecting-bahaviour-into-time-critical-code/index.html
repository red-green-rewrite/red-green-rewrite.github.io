<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Injecting bahaviour into time critical code | Red, Green, Rewrite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Thanks!This post was heavily inspired by infographics by Bartosz Adamczewski @badamczewski01 and wouldn’t be possible without sharplab.io by Andrey Shchekin @ashmind and BenchmarkDotNet by contributor">
<meta property="og:type" content="article">
<meta property="og:title" content="Injecting bahaviour into time critical code">
<meta property="og:url" content="http://red-green-rewrite.github.io/2021/09/12/Injecting-bahaviour-into-time-critical-code/index.html">
<meta property="og:site_name" content="Red, Green, Rewrite">
<meta property="og:description" content="Thanks!This post was heavily inspired by infographics by Bartosz Adamczewski @badamczewski01 and wouldn’t be possible without sharplab.io by Andrey Shchekin @ashmind and BenchmarkDotNet by contributor">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-09-12T19:31:43.000Z">
<meta property="article:modified_time" content="2021-09-12T21:24:08.798Z">
<meta property="article:author" content="Milosz Krajewski">
<meta property="article:tag" content="csharp">
<meta property="article:tag" content="performance">
<meta property="article:tag" content="sort">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Red, Green, Rewrite" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-94127827-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Red, Green, Rewrite</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://red-green-rewrite.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Injecting-bahaviour-into-time-critical-code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/12/Injecting-bahaviour-into-time-critical-code/" class="article-date">
  <time datetime="2021-09-12T19:31:43.000Z" itemprop="datePublished">2021-09-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Injecting bahaviour into time critical code
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks!"></a>Thanks!</h2><p>This post was heavily inspired by infographics by Bartosz Adamczewski <a target="_blank" rel="noopener" href="https://twitter.com/badamczewski01">@badamczewski01</a> and wouldn’t be possible without <a target="_blank" rel="noopener" href="https://sharplab.io/">sharplab.io</a> by Andrey Shchekin <a target="_blank" rel="noopener" href="https://twitter.com/ashmind">@ashmind</a> and <a target="_blank" rel="noopener" href="https://benchmarkdotnet.org/">BenchmarkDotNet</a> by <a target="_blank" rel="noopener" href="https://github.com/dotnet/BenchmarkDotNet/graphs/contributors">contributors</a>.</p>
<h2 id="Context-TimSort-for-NET"><a href="#Context-TimSort-for-NET" class="headerlink" title="Context: TimSort for .NET"></a>Context: TimSort for .NET</h2><p>So I wanted to (re)implemented TimSort for .NET. My previous attempt was relatively successful (well, it worked) but it could be better. Closure of <a target="_blank" rel="noopener" href="https://archive.codeplex.com/">CodePlex</a> (that’s where it was hosted before) gave me perfect opportunity - I need to move it, but I can also rewrite it.</p>
<p>One of the problems with original implementation was the fact that I wanted to have all types of array-like objects (<code>Array</code>, <code>List</code>, and <code>IList</code>). The problem is the choice was (at least that’s what I thought at the time) implementing it 3 times, or implementing it for <code>IList</code> only and take the performance hit (as accessing <code>Array</code> though <code>IList</code> interface comes at the price).</p>
<p>In the end, it was implemented 3 times and do avoid maintaining 3 code bases the actual algorithm was in <code>T4</code> template (<code>.tt</code> file) so 3 implementations were generated from it. </p>
<p>Time has shown that I knew very little then…</p>
<h2 id="Insertion-sort"><a href="#Insertion-sort" class="headerlink" title="Insertion sort"></a>Insertion sort</h2><p>This post is not about TimSort though (as at the time of writing it is not finished yet). This post is about injecting behaviour into algorithms while retaining original performance.</p>
<p>So, insertion sort is simple <em>O(n^2)</em> sorting algorithm, which actually has some real-life usage. It is actually irrelevant, which one I use for this post, but if I need to use any let’s use the one which is actually has some use cases: it is very fast (<em>O(n)</em>) for data which is nearly sorted and is used as a part of IntroSort combo (quicksort + heapsort + insertion sort). For example, IntroSort <a target="_blank" rel="noopener" href="https://source.dot.net/#System.Private.CoreLib/ArraySortHelper.cs">is used by .NET</a>.</p>
<p>Let’s start:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sort</span>(<span class="params"><span class="built_in">int</span>[] array, <span class="built_in">int</span> start, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> lo = start;</span><br><span class="line">    <span class="keyword">var</span> hi = start + length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = lo + <span class="number">1</span>; i &lt; hi; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = i; j &gt; lo; j--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (array[j - <span class="number">1</span>] &lt;= array[j])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Swap(array, j, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">int</span>[] array, <span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> swap = array[a];</span><br><span class="line">    array[a] = array[b];</span><br><span class="line">    array[b] = swap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>…and measure baseline implementation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)</span><br><span class="line">AMD Ryzen 5 3600, 1 CPU, 12 logical and 6 physical cores</span><br><span class="line">.NET SDK=5.0.300</span><br><span class="line">  [Host]     : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line"></span><br><span class="line">|     Method |  Size |      Mean |     Error |    StdDev |</span><br><span class="line">|----------- |------ |----------:|----------:|----------:|</span><br><span class="line">| ArrayOfInt | 10000 |  7.226 us | 0.0371 us | 0.0347 us | &lt;==</span><br></pre></td></tr></table></figure>

<h2 id="Will-it-work-for-any-type"><a href="#Will-it-work-for-any-type" class="headerlink" title="Will it work for any type?"></a>Will it work for any type?</h2><p>That’s the problem. It was been tailored for <strong>array of ints</strong> (<code>int[]</code>). There are two issues to address: accessing generic indexable data (let’s say <code>IList&lt;...&gt;</code>) and comparing items (let’s say <code>IComparer&lt;...&gt;</code>).</p>
<p>That’s super simple! Let’s do it!</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sort</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    IList&lt;T&gt; array, <span class="built_in">int</span> start, <span class="built_in">int</span> length, IComparer&lt;T&gt; comparer</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> lo = start;</span><br><span class="line">    <span class="keyword">var</span> hi = start + length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = lo + <span class="number">1</span>; i &lt; hi; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = i; j &gt; lo; j--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparer.Compare(array[j - <span class="number">1</span>], array[j]) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Swap(array, j, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>&lt;<span class="title">T</span>&gt;(<span class="params">IList&lt;T&gt; array, <span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> swap = array[a];</span><br><span class="line">    array[a] = array[b];</span><br><span class="line">    array[b] = swap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That wasn’t hard, was it? Fantastic, problem solved new implementation works for <code>int[]</code> as well but is completely generic. PROFIT! Let’s just measure performance and go home…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)</span><br><span class="line">AMD Ryzen 5 3600, 1 CPU, 12 logical and 6 physical cores</span><br><span class="line">.NET SDK=5.0.300</span><br><span class="line">  [Host]     : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">|     Method |  Size |      Mean |     Error |    StdDev |</span><br><span class="line">|----------- |------ |----------:|----------:|----------:|</span><br><span class="line">| ArrayOfInt | 10000 |  7.209 us | 0.0209 us | 0.0175 us |</span><br><span class="line">|    ListOfT | 10000 | 62.408 us | 0.2216 us | 0.1730 us | &lt;==</span><br></pre></td></tr></table></figure>

<p>…or not. <strong>It is 9 times slower now</strong> (62.408 us vs 7.209 us).</p>
<h2 id="I-heard-it-is-about-virtual-calls-to-interfaces"><a href="#I-heard-it-is-about-virtual-calls-to-interfaces" class="headerlink" title="I heard it is about virtual calls to interfaces?"></a>I heard it is about virtual calls to interfaces?</h2><p>Yes, it is. Simple comparison (most likely one assembler instruction) became a <em>call to virtual method</em> which is (relatively) very slow. What can we do though? Well, not pass interfaces but pass classes, yes? Well, it still would need to be virtual call to make behaviour polymorphic. </p>
<p>How to make a static call to something with polymorphic behavior? This sounds stu… Generics!</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sort</span>&lt;<span class="title">T</span>, <span class="title">TIndexer</span>, <span class="title">TComparer</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    TIndexer array, <span class="built_in">int</span> start, <span class="built_in">int</span> length, TComparer comparer</span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TIndexer: IList&lt;T&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TComparer: IComparer&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> lo = start;</span><br><span class="line">    <span class="keyword">var</span> hi = start + length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = lo + <span class="number">1</span>; i &lt; hi; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = i; j &gt; lo; j--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparer.Compare(array[j - <span class="number">1</span>], array[j]) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Swap&lt;T, TIndexer&gt;(array, j, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>&lt;<span class="title">T</span>, <span class="title">TIndexer</span>&gt;(<span class="params">TIndexer array, <span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TIndexer: IList&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> swap = array[a];</span><br><span class="line">    array[a] = array[b];</span><br><span class="line">    array[b] = swap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now all calls are done to actual class not to interface so when we call:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sort&lt;<span class="built_in">int</span>, <span class="built_in">int</span>[], Comparer&lt;<span class="built_in">int</span>&gt;&gt;(_data, <span class="number">0</span>, _data.Length, Comparer&lt;<span class="built_in">int</span>&gt;.Default);</span><br></pre></td></tr></table></figure>

<p>it hopefully will get expanded to call actual <code>int[]</code> not <code>IList&lt;int&gt;</code>… Let’s measure it:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)</span><br><span class="line">AMD Ryzen 5 3600, 1 CPU, 12 logical and 6 physical cores</span><br><span class="line">.NET SDK=5.0.300</span><br><span class="line">  [Host]     : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">|          Method |  Size |      Mean |     Error |    StdDev |</span><br><span class="line">|---------------- |------ |----------:|----------:|----------:|</span><br><span class="line">|      ArrayOfInt | 10000 |  7.232 us | 0.0371 us | 0.0347 us |</span><br><span class="line">|         ListOfT | 10000 | 62.414 us | 0.2206 us | 0.1956 us |</span><br><span class="line">| ListOfTGenerics | 10000 | 62.333 us | 0.0631 us | 0.0492 us | &lt;==</span><br></pre></td></tr></table></figure>

<p><strong>Oh my, it is not working! It is actually completely identical (63.333 us) and it still calls interfaces.</strong></p>
<p>Does it mean that I really need to implement it multiple times, for <code>Array</code>, <code>List</code>, <code>IList</code> and… <code>Span</code>? Is there any way to implement it just once but use in different contexts? </p>
<h2 id="Value-types-for-the-win"><a href="#Value-types-for-the-win" class="headerlink" title="Value types for the win!"></a>Value types for the win!</h2><p>Wait a seconds… When .NET expands generic class it does it for each value type separately, but not for reference types. That’s why even if <code>int[]</code> was passed as generic argument it was not generating “dedicated” implementation for <code>int[]</code> it was still using <code>IList&lt;int&gt;</code> interface. Let’s try to force it by using value types.</p>
<p>NOTE: I don’t want to use implement whole <code>IList&lt;T&gt;</code> in my struct so let’s simplify it a little bit as the only thing we actually use from <code>IList&lt;T&gt;</code> is indexed access:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IIndexer</span>&lt;<span class="title">T</span>&gt; &#123; T <span class="keyword">this</span>[<span class="built_in">int</span> index] &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>so now we can implement struct which implements this interface for array:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">struct</span> ArrayIndexer&lt;T&gt;: IIndexer&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> T[] _array;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayIndexer</span>(<span class="params">T[] array</span>)</span> =&gt; _array = array;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="keyword">this</span>[<span class="built_in">int</span> index]</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line">        <span class="keyword">get</span> =&gt; _array[index];</span><br><span class="line">        [<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line">        <span class="keyword">set</span> =&gt; _array[index] = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can (re)implement insertion sort using this interface:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sort</span>&lt;<span class="title">T</span>, <span class="title">TIndexer</span>, <span class="title">TComparer</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    TIndexer array, <span class="built_in">int</span> start, <span class="built_in">int</span> length, TComparer comparer</span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TIndexer: IIndexer&lt;T&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TComparer: IComparer&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> lo = start;</span><br><span class="line">    <span class="keyword">var</span> hi = start + length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = lo + <span class="number">1</span>; i &lt; hi; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = i; j &gt; lo; j--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparer.Compare(array[j - <span class="number">1</span>], array[j]) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Swap&lt;T, TIndexer&gt;(array, j, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>&lt;<span class="title">T</span>, <span class="title">TIndexer</span>&gt;(<span class="params">TIndexer array, <span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TIndexer: IIndexer&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> swap = array[a];</span><br><span class="line">    array[a] = array[b];</span><br><span class="line">    array[b] = swap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(NOTE: nothing changed in implementation, just method signature is slightly different)</p>
<p>Seems that BenchmarkDotNet agrees with me as we definitely have improvement (26.331 us):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)</span><br><span class="line">AMD Ryzen 5 3600, 1 CPU, 12 logical and 6 physical cores</span><br><span class="line">.NET SDK=5.0.300</span><br><span class="line">  [Host]     : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">|          Method |  Size |      Mean |     Error |    StdDev |</span><br><span class="line">|---------------- |------ |----------:|----------:|----------:|</span><br><span class="line">|      ArrayOfInt | 10000 |  7.214 us | 0.0259 us | 0.0242 us |</span><br><span class="line">|         ListOfT | 10000 | 62.333 us | 0.1479 us | 0.1155 us |</span><br><span class="line">| ListOfTGenerics | 10000 | 62.429 us | 0.1847 us | 0.1637 us |</span><br><span class="line">|      IndexerOfT | 10000 | 26.331 us | 0.0338 us | 0.0316 us | &lt;==</span><br></pre></td></tr></table></figure>

<p>Let’s do it for comparer as well. The only thing which we actually want from <code>Comparer</code> in this algorithm is <code>&lt;=</code> (less or equal), so, let’s make a dedicated interface and dedicated implementation for <code>int</code> (because that’s what we are measuring):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILessOrEqual</span>&lt;<span class="title">T</span>&gt; &#123; <span class="function"><span class="built_in">bool</span> <span class="title">LeEq</span>(<span class="params"><span class="keyword">in</span> T a, <span class="keyword">in</span> T b</span>)</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">struct</span> IntComparer: ILessOrEqual&lt;<span class="built_in">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">LeEq</span>(<span class="params"><span class="keyword">in</span> <span class="built_in">int</span> a, <span class="keyword">in</span> <span class="built_in">int</span> b</span>)</span> =&gt; a &lt;= b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can modify implementation of algorithm to take this <code>ILessOrEqual&lt;T&gt;</code> interface:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sort</span>&lt;<span class="title">T</span>, <span class="title">TIndexer</span>, <span class="title">TComparer</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">in</span> TIndexer array, <span class="built_in">int</span> start, <span class="built_in">int</span> length, <span class="keyword">in</span> TComparer comparer</span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TIndexer: IIndexer&lt;T&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TComparer: ILessOrEqual&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> lo = start;</span><br><span class="line">    <span class="keyword">var</span> hi = start + length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = lo + <span class="number">1</span>; i &lt; hi; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = i; j &gt; lo; j--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparer.LeEq(array[j - <span class="number">1</span>], array[j]))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Swap&lt;T, TIndexer&gt;(array, j, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So that would be it, let’s measure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)</span><br><span class="line">AMD Ryzen 5 3600, 1 CPU, 12 logical and 6 physical cores</span><br><span class="line">.NET SDK=5.0.300</span><br><span class="line">  [Host]     : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 5.0.6 (5.0.621.22011), X64 RyuJIT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">|                Method |  Size |      Mean |     Error |    StdDev |</span><br><span class="line">|---------------------- |------ |----------:|----------:|----------:|</span><br><span class="line">|            ArrayOfInt | 10000 |  7.215 us | 0.0186 us | 0.0165 us |</span><br><span class="line">|               ListOfT | 10000 | 62.525 us | 0.2124 us | 0.1658 us |</span><br><span class="line">|       ListOfTGenerics | 10000 | 62.431 us | 0.1498 us | 0.1251 us |</span><br><span class="line">|            IndexerOfT | 10000 | 26.364 us | 0.0996 us | 0.0883 us |</span><br><span class="line">| IndexerOfTAndComparer | 10000 |  9.604 us | 0.0271 us | 0.0226 us | &lt;==</span><br></pre></td></tr></table></figure>

<p>We are not yet there but definitely time was brought down to single digits.</p>
<p>Definitely calling this method is little bit cumbersome right now:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Sort&lt;<span class="built_in">int</span>, ArrayIndexer&lt;<span class="built_in">int</span>&gt;, IntComparer&gt;(</span><br><span class="line">    <span class="keyword">new</span> ArrayIndexer&lt;<span class="built_in">int</span>&gt;(array), <span class="number">0</span>, array.Length, <span class="keyword">new</span> IntComparer());</span><br></pre></td></tr></table></figure>

<p>but this can be hidden behind some nice overloads and you will have few of them (for <code>T[]</code>, <code>List&lt;T&gt;</code>, <code>IList&lt;T&gt;</code>, or even <code>IDictionary&lt;int, T&gt;</code> - why not). The story behind <code>Span&lt;T&gt;</code> is slightly different. Possible, but a little bit more complicated (pinning is required).</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The point is <strong>it can be almost as fast as dedicated version but also as generic as fully generic version</strong>. </p>
<p>Please note, it will be expanded for each indexer/comparer combination so your code will take more memory when JITted, but I don’t think this might be a problem.</p>
<p>To be honest I’m quite surprised it is not identical to dedicated version because all those <code>[MethodImpl(MethodImplOptions.AggressiveInlining)]</code> should make JIT generate almost identical machine code, but maybe we are not there yet (with JIT). I was testing it on very small code samples (like <code>this[7]</code> and in such cases generated assembler was 100% identical).</p>
<p>I understand <a target="_blank" rel="noopener" href="https://github.com/NetFabric/NetFabric.Hyperlinq">NetFabric.Hyperlinq</a> uses same approach with <a target="_blank" rel="noopener" href="https://github.com/NetFabric/NetFabric.Hyperlinq#value-delegates">Value delegates</a> to make LINQ a little bit more performant without losing flexibility.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://red-green-rewrite.github.io/2021/09/12/Injecting-bahaviour-into-time-critical-code/" data-id="ckthq74wu0004y4jber1ydxi2" class="article-share-link">Share</a>
      
        <a href="http://red-green-rewrite.github.io/2021/09/12/Injecting-bahaviour-into-time-critical-code/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sort/" rel="tag">sort</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/03/10/Saving-New-York-with-F-Bloxorz-and-John-McClane/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Saving New York with F#, Bloxorz and John McClane</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/" rel="tag">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fable/" rel="tag">fable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fsharp/" rel="tag">fsharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/functional/" rel="tag">functional</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kata/" rel="tag">kata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-js/" rel="tag">kotlin.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maze/" rel="tag">maze</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/" rel="tag">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala-js/" rel="tag">scala.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/state-machine/" rel="tag">state-machine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/" rel="tag">tree</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/csharp/" style="font-size: 15px;">csharp</a> <a href="/tags/design/" style="font-size: 11.67px;">design</a> <a href="/tags/fable/" style="font-size: 13.33px;">fable</a> <a href="/tags/fsharp/" style="font-size: 18.33px;">fsharp</a> <a href="/tags/functional/" style="font-size: 11.67px;">functional</a> <a href="/tags/kata/" style="font-size: 10px;">kata</a> <a href="/tags/kotlin/" style="font-size: 13.33px;">kotlin</a> <a href="/tags/kotlin-js/" style="font-size: 11.67px;">kotlin.js</a> <a href="/tags/maze/" style="font-size: 16.67px;">maze</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/scala-js/" style="font-size: 10px;">scala.js</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/state-machine/" style="font-size: 10px;">state-machine</a> <a href="/tags/tree/" style="font-size: 10px;">tree</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/09/12/Injecting-bahaviour-into-time-critical-code/">Injecting bahaviour into time critical code</a>
          </li>
        
          <li>
            <a href="/2018/03/10/Saving-New-York-with-F-Bloxorz-and-John-McClane/">Saving New York with F#, Bloxorz and John McClane</a>
          </li>
        
          <li>
            <a href="/2017/03/20/Further-than-SAM/">Further than SAM</a>
          </li>
        
          <li>
            <a href="/2017/03/12/You-are-better-off-with-SAM/">You are better off with SAM</a>
          </li>
        
          <li>
            <a href="/2016/10/30/Kruskal-DFS-hybrid-with-reduced-branching-factor/">Kruskal/DFS hybrid with reduced branching factor</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Milosz Krajewski<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'red-green-rewrite';
  
  var disqus_url = 'http://red-green-rewrite.github.io/2021/09/12/Injecting-bahaviour-into-time-critical-code/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>