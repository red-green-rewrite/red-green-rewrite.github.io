<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>You are better off with SAM | Red, Green, Rewrite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="NOTE: This is part one of two part article. You can read second part here. To be honest, this is where interesting stuff starts.

This introduction is for hard core OO developers (mostly C# but maybe">
<meta property="og:type" content="article">
<meta property="og:title" content="You are better off with SAM">
<meta property="og:url" content="http://red-green-rewrite.github.io/2017/03/12/You-are-better-off-with-SAM/index.html">
<meta property="og:site_name" content="Red, Green, Rewrite">
<meta property="og:description" content="NOTE: This is part one of two part article. You can read second part here. To be honest, this is where interesting stuff starts.

This introduction is for hard core OO developers (mostly C# but maybe">
<meta property="og:image" content="http://red-green-rewrite.github.io/images/sam/oo-intellisense.png">
<meta property="og:updated_time" content="2017-03-21T03:16:53.784Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="You are better off with SAM">
<meta name="twitter:description" content="NOTE: This is part one of two part article. You can read second part here. To be honest, this is where interesting stuff starts.

This introduction is for hard core OO developers (mostly C# but maybe">
<meta name="twitter:image" content="http://red-green-rewrite.github.io/images/sam/oo-intellisense.png">
  
    <link rel="alternate" href="/atom.xml" title="Red, Green, Rewrite" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Red, Green, Rewrite</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">the tales about software development</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://red-green-rewrite.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-You-are-better-off-with-SAM" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/12/You-are-better-off-with-SAM/" class="article-date">
  <time datetime="2017-03-12T16:44:16.000Z" itemprop="datePublished">2017-03-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      You are better off with SAM
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>NOTE:</strong> This is part one of two part article. You can read second part <a href="/2017/03/20/Further-than-SAM/"><strong>here</strong></a>. To be honest, this is where interesting stuff starts.</p>
<hr>
<p>This introduction is for hard core OO developers (mostly C# but maybe Java as well) who are trying to add FP to their skillset. If you are FP developer, you most likely know all those things.</p>
<p><em>SAM</em> is the term introduced in Java 8 and means “Single Abstract Method”. It’s describes an interface with only one method. Of course, we had them before (both in Java and C#):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// C#</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IComparer</span>&lt;<span class="title">T</span>&gt; </span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Compare</span><span class="params">(T alpha, T bravo)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt; </span></div><div class="line">&#123;</div><div class="line">    <span class="function">IEnumerator&lt;T&gt; <span class="title">GetEnumerator</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>but they became more visible in Java 8, as they were used to implement very important language feature. We will talk about this in few moments.</p>
<h2 id="Design-with-SAM"><a href="#Design-with-SAM" class="headerlink" title="Design with SAM"></a>Design with SAM</h2><p>Designing your system with <em>SAMs</em> has some quantifiable advantages.</p>
<p>First of all, it helps with <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle" target="_blank" rel="external">Single Responsibility Principle</a> and <a href="https://en.wikipedia.org/wiki/Interface_segregation_principle" target="_blank" rel="external">Interface Segregation Principle</a>. Don’t get me wrong, it is still possible to do it wrong, and create single method with multiple responsibilities. Actually, some of the solutions presented in this article are not the purest, but they are, I hope at least, move in the right direction. </p>
<p>Second, your <em>SAM</em> interfaces are easier to implement. Did you ever try replace a component and found out that interface you need to implement has 50 methods? It just smells like “Oh, we had this God Object with some random methods and doing everything, but someone told us we need interfaces so we extracted every single possible method, job’s done”. They usually never get implemented again.</p>
<p>Third, they are easier to mock. I’m kind of reiterating second point here: they are easier to mock as there is only one method to fake, stub or mock (it’s not the same, I know, but whatever you call it, it’s still easier). You may say, that for bigger interfaces, you still need to mock only one method for a particular test. But which one, I would ask? Oh, the one which given test actually uses. Really? So now, you are making assumptions how exactly tested method works, instead of providing dependencies are checking if it satisfies acceptance criteria? Why testing it at all then? It is also a recipe for brittle tests. Change implementation a bit and your test will start to fail because your function under test calls different overload now (for example, the one with timeout passed as <code>TimeSpan</code> rather than <code>int</code>). Design it with <em>SAM</em> at there will be only one method to mock.</p>
<p>Oh, I forgot to mention, Functional Programmers also have a name for <em>SAM</em>, they call it… <em>a function</em>.</p>
<div style="text-align: center"><br><iframe width="560" height="315" src="https://www.youtube.com/embed/gxf9V_GYDdc" frameborder="0" allowfullscreen></iframe><br><br><a href="https://www.youtube.com/watch?v=E8I19uA-wGY&amp;t=274s" target="_blank" rel="external">highly recommended full version here</a><br></div>

<h2 id="SAM-in-Java"><a href="#SAM-in-Java" class="headerlink" title="SAM in Java"></a>SAM in Java</h2><p>Java has anonymous classes for injecting behaviour since 1997 (Java 1.1), so in Java world the concept is not new at all. Using them was just very clunky:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Action</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(T item)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Iterable&lt;T&gt; collection, Action action)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (T item : collection) &#123;</div><div class="line">        action.run(item);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printAll</span><span class="params">(Iterable&lt;String&gt; strings)</span> </span>&#123;</div><div class="line">    forEach(</div><div class="line">        strings,</div><div class="line">        <span class="keyword">new</span> Action&lt;String&gt;() &#123;             <span class="comment">// &lt;-- starts here...</span></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String item)</span> </span>&#123;</div><div class="line">                System.out.println(item);</div><div class="line">            &#125;</div><div class="line">        &#125;                                  <span class="comment">// &lt;-- ...and ends here</span></div><div class="line">    ); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you look closely, the anonymous class implementing <code>Action</code> interface in <code>printAll</code> is what we would call lambda in C#. It is just completely wrist-unfriendly. </p>
<p>When lambdas were added, they wanted all those functions to support lambda. Who doesn’t like lambdas? Right? But they couldn’t just change them, as Java is all about backwards compatibility. Duplicating every method (to accept anonymous class or lambda) would be a huge task. They decided, and so far it seems like a smart move, that they won’t change the interfaces, they will just modify the compiler to generate those, a little bit inflated, anonymous classes for you (NOTE: this is exactly true, Java 8 implementation of lambdas is actually quite optimized):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Action</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(T item)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Iterable&lt;T&gt; collection, Action action)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (T item : collection) &#123;</div><div class="line">        action.run(item);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printAll</span><span class="params">(Iterable&lt;String&gt; strings)</span> </span>&#123;</div><div class="line">    forEach(strings, item -&gt; System.out.println(item)); <span class="comment">// &lt;-- starts and ends here :-)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>From inside of <code>forEach</code> method nothing has changed, it still “thinks” it works with class implementing <code>Action</code> interface, but this class has been generated on the fly (well, again, not exactly true, but good-enough) from lambda.<br>This mechanics immediately breaks, of course, when expected interface has more than one (abstract) method, as we can only implement one with lambda function.</p>
<p>Anyway, what’s important to remember is the fact that interface with single abstract method is technically a function, and a function is technically an interface with single abstract method, for example, with <code>IComparer</code> and <code>Comparison</code> defined below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IComparer</span>&lt;<span class="title">in</span> <span class="title">T</span>&gt; </span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Compare</span><span class="params">(T x, T y)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> delegate <span class="keyword">int</span> Comparison&lt;in T&gt;(T x, T y);</div></pre></td></tr></table></figure>
<p>we can easily implement conversion function both ways: converting <code>IComparer</code> to <code>Comparison</code> is trivial as <code>IComparer.Compare</code> is-a <code>Comparison</code> while conversion the other way around would require a wrapper:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class AdhocComparer&lt;T&gt;: IComparer&lt;T&gt;</div><div class="line">&#123;</div><div class="line">    private readonly Comparison&lt;T&gt; _comparison;</div><div class="line"></div><div class="line">    public AdhocComparer(Comparison&lt;t&gt; comparison) &#123;</div><div class="line">        _comparison = comparison;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int Compare(T x, T y) =&gt; _comparison(x, y);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// for some reason syntax highlight sometimes fails</div></pre></td></tr></table></figure>
<p>I will point this fact again later, but please note that this is not a coincidence that converting to FP is usually trivial, while conversion to OO requires a little wrapper. Usually (at least) 4 lines: a class declaration, a field to store the function, a constructor to take function as argument, and single abstract method calling this function. That’s exactly what Java compiler does.</p>
<p>Nevertheless, SAM is function, function is SAM.</p>
<h2 id="Design-logging-framework-with-SAM"><a href="#Design-logging-framework-with-SAM" class="headerlink" title="Design logging framework with SAM"></a>Design logging framework with SAM</h2><p>If you ever used <code>NLog</code> or <code>log4net</code> you can imagine a <code>ILoggerFactory</code> and <code>ILogger</code> interfaces to be declared like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoggerFactory</span> </div><div class="line">&#123;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params">Type type</span>)</span>;</div><div class="line">    ILogger Logger&lt;T&gt;();</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"></span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Right? With <code>ILoggerFactory</code> we can get logger with given name, logger for given type, or for given type but passed as generic, and maybe a logger for current scope (most likely it will be a class). With <code>ILogger</code> you can log messages of different severity (Trace, Debug, Info, etc.), and provide messages in few different ways: as a string, or maybe as a pattern to be expanded when logging, with or without <code>Exception</code>. </p>
<p>Anyway, great, let’s start implementing it. Method by method… Just joking.</p>
<p>It is one of those interfaces you should really ask: <em>I really like all those methods, and I want them to be available but do I need to implement them all?</em> No, you don’t.</p>
<h2 id="Reduce-to-SAM"><a href="#Reduce-to-SAM" class="headerlink" title="Reduce to SAM"></a>Reduce to SAM</h2><p>Let’s start with <code>ILoggerFactory</code> as it is much easier. You can notice that somewhere on the end, regardless which method on <code>ILoggerFactory</code> we call, we end up in <code>Logger(string)</code> as this is logger’s primary constructor and all other methods use it in some way:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ILogger <span class="title">Logger</span>(<span class="params">Type type</span>) </span>=&gt; Logger(type.FullName);</div><div class="line">ILogger Logger&lt;T&gt;() =&gt; Logger(<span class="keyword">typeof</span>(T));</div><div class="line"><span class="function">ILogger <span class="title">Logger</span>(<span class="params"></span>) </span>=&gt; Logger(<span class="keyword">new</span> StackTrace().GetFrame(<span class="number">1</span>).GetMethod().DeclaringType);</div></pre></td></tr></table></figure>
<p>There is nothing in their implementation which would require them to be re-implemented in every possible implementation of <code>ILoggerFactory</code>. So, technically, this interface should be actually reduced to:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoggerFactory</span> </div><div class="line">&#123;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Single. Abstract. Method.</strong></p>
<p>Although, you want all the convenience methods to be available. Right? Right.</p>
<h2 id="Extending-SAM"><a href="#Extending-SAM" class="headerlink" title="Extending SAM"></a>Extending SAM</h2><p>I can think of three obvious ways to deliver them to the potential user:</p>
<ol>
<li><strong>Wrapper class</strong>: a new class, let’s say <code>ExtendedLoggerFactory</code>, which takes <code>ILoggerFactory</code> in constructor and delivers additional functionality.</li>
<li><strong>Abstract class</strong>: a class with a additional functionality implemented, but with <code>ILogger Logger(string)</code> left as abstract. No interface, just base class, let’s say <code>LoggerFactoryBase</code> (yup, a kitten just died somewhere).</li>
<li><strong>Extension methods</strong>: extension methods taking <code>ILoggerFactory</code> as <code>this</code></li>
</ol>
<p>For completeness, I have to say, that Scala has <em>traits</em> and <em>implicit wrappers</em>, while Java gives you <em>default methods</em>. It is outside of the scope this article, but worth googling (even if you are C# developer).</p>
<p>There are pros and cons to all of those solutions. </p>
<p>The <em>wrapper class</em> is probably the cleanest from OO perspective, but a little bit confusing and clunky: we implement <code>ILoggerFactory</code> but pass <code>ExtendedLoggerFactory</code> (alternatively, we can also pass <code>ILoggerFactory</code> and rewrap it all the time). Most of the clunkiness of this solution disappears when using IoC container (we always inject <code>ExtendedLoggerFactory</code> leaving <code>ILoggerFactory</code> for library developers). </p>
<p><em>Abstract class</em> does not have this problem but enforces specific base class, pulling all the dependencies with it. It’s a viable solution, but I tend to stay away from partially implemented abstract classes.</p>
<p><em>Extension methods</em> are quite controversial, as your extension methods are not polymorphic at all. Once defined, they cannot be overridden. With some functions it is not a problem as there is not “other” implementation of LINQ <code>Where</code> or <code>Select</code>, but it is possible to get it too far. If you think your extension methods may be controversial “hide” them in some namespace with needs to be imported explicitly, for example: <code>LoggingFramework.Extensions</code>. It you think they are just fine, put them into the same namespace as interface, let’s say <code>LoggingFramework.Core</code>. If you think they are so great that everyone should use them day and night, stick them into <code>System.Linq</code> (and add all the warning suppression directives). Definitely, this can make development very easy (because extension are always available thanks to IntelliSense), or it can make you very unpopular (for exactly the same reason). Use them wisely.</p>
<p>In this article I decided to go for <em>extension methods</em>. I think this approach is relatively pragmatic, never had problem with it in a field and even if there is a potential flaw, the net effect is positive. Actually, Reactive Extensions are using the same technique (just check what is available on <code>IObservable&lt;T&gt;</code> interface with and without <code>System.Reactive</code> namespace imported).</p>
<p>So, after this long introduction, the declaration of the interface and implementation of convenience methods:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoggerFactory</span> </div><div class="line">&#123;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">LoggerFactoryExtensions</span></div><div class="line">&#123;</div><div class="line">    [MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">this</span> ILoggerFactory factory</span>) </span>=&gt;</div><div class="line">        factory.Logger(<span class="keyword">new</span> StackTrace().GetFrame(<span class="number">1</span>).GetMethod().DeclaringType);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">this</span> ILoggerFactory factory, Type type</span>) </span>=&gt;</div><div class="line">        factory.Logger(type.FullName);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ILogger Logger&lt;T&gt;(<span class="keyword">this</span> ILoggerFactory factory) =&gt;</div><div class="line">        factory.Logger(<span class="keyword">typeof</span>(T));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Single method on the interface, and some extension methods, which are just redirecting calls to that interface.</p>
<h2 id="Reducing-ILogger-to-SAM"><a href="#Reducing-ILogger-to-SAM" class="headerlink" title="Reducing ILogger to SAM"></a>Reducing ILogger to SAM</h2><p><code>ILogger</code> is quite big. It is also quite repetitive:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Trace</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Debug</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Info</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Warn</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Error</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params"><span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Fatal</span>(<span class="params">Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Please note, that the methods here are Cartesian product of all choices we can make:</p>
<ul>
<li>6 severity levels (Debug, Trace, Info, Warn, Error, Fatal)</li>
<li>2 ways to pass exception (with or without exception)</li>
<li>3 ways to format parameters (<code>string</code>, <code>Func&lt;string&gt;</code> and <code>string, params object[]</code>)</li>
</ul>
<p>So we have <code>6 x 2 x 3 = 36</code> methods.</p>
<p>Let’s move one of the choices out of the interface, and introduce <code>Severity</code> enum. It will reduce this interface to just 6 methods:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Severity </div><div class="line">&#123;</div><div class="line">     Trace, Debug, Info, Warn, Error, Fatal</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Exception error, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Exception error, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Exception error, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>It’s the same technique you might have used for <em>database normalization</em>. </p>
<p>Next, I think that doubling number of overloads, only because we can call it with or without <code>Exception</code> is unnecessary, one dedicated overload for <code>Exception</code> is enough:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> message</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Exception error</span>)</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Before we proceed it might be important to explain why these method pair exists (not only in our implementation, but in general, in all logging frameworks):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> message</span>)</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</div></pre></td></tr></table></figure>
<p>Isn’t the second one equivalent to calling first one with <code>string.Format(...)</code> (or with <code>$&quot;...&quot;</code>)?</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Log(Severity.Error, pattern, arg1, args2, ...);</div><div class="line">Log(Severity.Error, <span class="keyword">string</span>.Format(pattern, arg1, args2, ...));</div></pre></td></tr></table></figure>
<p>Well, effect is the same, but side effects are different. When we leave expansion to the logging framework it won’t be done if logging is disabled (let’s say in production we do not log <code>Severity.Trace</code>). When doing string expansion yourself (<code>string.Format</code> or <code>$&quot;...&quot;</code>) you do this <em>before</em> framework has a chance to decide if logging is enabled, so you do this even if expanded string is going to be swallowed, wasting CPU cycles and risking exception being thrown during this operation. </p>
<p>We already have deferral mechanism in this interface, though: <code>Func&lt;string&gt;</code>. Actually, all those four overloads can be implemented using only one method on interface and convenience method on extender:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">LoggerExtensions</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params"></span></span></div><div class="line">        <span class="keyword">this</span> ILogger logger, Severity severity, <span class="keyword">string</span> message) =&gt;</div><div class="line">            logger.Log(severity, () =&gt; message);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params"></span></span></div><div class="line">        <span class="keyword">this</span> ILogger logger, Severity severity, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args) =&gt;</div><div class="line">            logger.Log(severity, () =&gt; <span class="keyword">string</span>.Format(pattern, args));</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params"></span></span></div><div class="line">        <span class="keyword">this</span> ILogger logger, Severity severity, Exception error) =&gt;</div><div class="line">            logger.Log(severity, error.ToString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>NOTE: <code>Exception.ToString</code> is <code>Func&lt;string&gt;</code></p>
<p>Of course, we want our convenience methods back. Let’s add them as extension methods, using T4 template engine this time (we could do this by hand, as this is generated only once, but using T4 is useful skill to have):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MoreLoggerExtensions</span></div><div class="line">&#123;</div><div class="line">&lt;<span class="meta"># foreach (var level in new[] &#123; "Trace", "Debug", "Info", "Warn", "Error", "Fatal" &#125;) &#123; #&gt;</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">region</span> &lt;#= level #&gt;</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;<span class="meta">#= level #&gt;(this ILogger logger, string message) =&gt;</span></div><div class="line">        logger.Log(Severity.&lt;<span class="meta">#= level #&gt;, message);</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;<span class="meta">#= level #&gt;(this ILogger logger, Func&lt;string&gt; builder) =&gt;</span></div><div class="line">        logger.Log(Severity.&lt;<span class="meta">#= level #&gt;, builder);</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;<span class="meta">#= level #&gt;(</span></div><div class="line">        <span class="keyword">this</span> ILogger logger, <span class="keyword">string</span> pattern, <span class="keyword">params</span> <span class="keyword">object</span>[] args) =&gt;</div><div class="line">            logger.Log(Severity.&lt;<span class="meta">#= level #&gt;, pattern, args);</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;<span class="meta">#= level #&gt;(this ILogger logger, Exception <span class="meta-keyword">error</span>) =&gt;</span></div><div class="line">        logger.Log(Severity.&lt;<span class="meta">#= level #&gt;, <span class="meta-keyword">error</span>);</span></div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></div><div class="line">&lt;<span class="meta"># LF(level != "Fatal"); &#125; #&gt;</span></div><div class="line">&#125;</div><div class="line">&lt;<span class="meta">#+ void LF(bool condition = true) &#123; <span class="meta-keyword">if</span> (condition) WriteLine(""); &#125; #&gt;</span></div></pre></td></tr></table></figure>
<p>Note that these methods are not necessary, they do not add new features. They are just convenient redirects. They do not have to be implemented ever again as long as <code>ILogger</code> has single abstract method <code>void Log(Severity severity, Func&lt;string&gt; builder)</code>.</p>
<h2 id="Implementing-adapters-for-NLog"><a href="#Implementing-adapters-for-NLog" class="headerlink" title="Implementing adapters for NLog"></a>Implementing adapters for NLog</h2><p>So we need to implement these two interfaces:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoggerFactory</span> </div><div class="line">&#123;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span> </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>to make NLog compatible with our logging facade. Let’s do it…</p>
<p>First thing which definitely needs to be addressed is the fact that NLog does not “understand” our <code>Severity</code>. It uses its own enumeration called <code>LogLevel</code>. We need to translate it:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LogLevel <span class="title">ToLogLevel</span>(<span class="params">Severity severity</span>) </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span> (severity) &#123;</div><div class="line">        <span class="keyword">case</span> Severity.Trace: <span class="keyword">return</span> LogLevel.Trace;</div><div class="line">        <span class="keyword">case</span> Severity.Debug: <span class="keyword">return</span> LogLevel.Debug;</div><div class="line">        <span class="keyword">case</span> Severity.Info: <span class="keyword">return</span> LogLevel.Info;</div><div class="line">        <span class="keyword">case</span> Severity.Warn: <span class="keyword">return</span> LogLevel.Warn;</div><div class="line">        <span class="keyword">case</span> Severity.Error: <span class="keyword">return</span> LogLevel.Error;</div><div class="line">        <span class="keyword">case</span> Severity.Fatal: <span class="keyword">return</span> LogLevel.Fatal;</div><div class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> LogLevel.Off;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Second thing is, NLog does not have an overload taking <code>Func&lt;string&gt;</code>. It has the one taking a <code>string</code> or a <code>string, params object[]</code>. We can settle with the <code>string</code> version and use:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> level = ToLogLevel(severity);</div><div class="line"><span class="keyword">if</span> (logger.IsEnabled(level))</div><div class="line">    logger.Log(level, builder());</div></pre></td></tr></table></figure>
<p>There is another way to do deferred expansion, though. It involves small wrapper class (again!) taking <code>Func&lt;string&gt;</code> and calling it in <code>.ToString()</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title">DeferredToString</span> </div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Func&lt;<span class="keyword">string</span>&gt; _builder;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DeferredToString</span>(<span class="params">Func&lt;<span class="keyword">string</span>&gt; builder</span>) </span>&#123; _builder = builder; &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ToString</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> _builder(); &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now, we could use it like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logger.Log(ToLogLevel(severity), <span class="string">"&#123;0&#125;"</span>, <span class="keyword">new</span> DeferredToString(builder));</div></pre></td></tr></table></figure>
<p>but, even if I actually like it more, it is not necessary and it has some negative performance implications. As I said before, the sole existence of this 4 line class is admission that OO design is not as expressive as FP.</p>
<p>Both ways, it will work just fine, and the implementation is:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NLogLoggerFactory</span>: <span class="title">ILoggerFactory</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>) </span>=&gt;</div><div class="line">        <span class="keyword">new</span> NLogLogger(LogManager.GetLogger(name));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NLogLogger</span>: <span class="title">ILogger</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Logger _logger;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NLogLogger</span>(<span class="params">Logger logger</span>) </span>&#123; _logger = logger; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> level = ToLogLevel(severity);</div><div class="line">        <span class="keyword">if</span> (_logger.IsEnabled(level))</div><div class="line">            _logger.Log(level, builder());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Done. Now NLog is compatible with our facade.</p>
<h2 id="Full-implementation"><a href="#Full-implementation" class="headerlink" title="Full implementation"></a>Full implementation</h2><p>So, let me reiterate, as might have disappeared in wall of text:</p>
<p>This is <strong>The Interface</strong>:</p>
<script src="https://gist.github.com/MiloszKrajewski/1ce82c560a750c79463b1a574a28a5e6.js?file=pocket-logging-oo-interfaces.cs"></script>

<p>These are <strong>The Extensions</strong>, a set of functions we extracted from interface, as they don’t really need to be there:</p>
<script src="https://gist.github.com/MiloszKrajewski/1ce82c560a750c79463b1a574a28a5e6.js?file=pocket-logging-oo-extensions.cs"></script>

<p>The third part is <strong>The Convenience Layer</strong>, an even bigger set of functions, which do not added functionality but make typing easier:</p>
<script src="https://gist.github.com/MiloszKrajewski/1ce82c560a750c79463b1a574a28a5e6.js?file=pocket-logging-oo-more-extensions.cs"></script>

<p>Please note, that this is not a <code>.cs</code> file, it is a <code>.tt</code> file, I just used <code>.cs</code> extension on gist to have syntax highlight. The expanded version of this template can be found <a href="https://gist.github.com/MiloszKrajewski/1ce82c560a750c79463b1a574a28a5e6#file-pocket-logging-oo-more-extensions-expanded-cs" target="_blank" rel="external">here</a></p>
<p>The last part, most likely in different assembly (as it has third party dependency) is <strong>The Adapter</strong>, adapting actual implementation to our abstract interface:</p>
<script src="https://gist.github.com/MiloszKrajewski/1ce82c560a750c79463b1a574a28a5e6.js?file=pocket-logging-oo-nlog-implementation.cs"></script>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>We reduced the interface surface from 40 methods (36 + 4), to 2 without affecting functionality, all you need to implement (or fake) logging system is this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoggerFactory</span></div><div class="line">&#123;</div><div class="line">    <span class="function">ILogger <span class="title">Logger</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params">Severity severity, Func&lt;<span class="keyword">string</span>&gt; builder</span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>All the methods are still available, though:</p>
<p><img src="/images/sam/oo-intellisense.png" alt="intellisense"></p>
<h2 id="Further-with-SAM"><a href="#Further-with-SAM" class="headerlink" title="Further with SAM"></a>Further with SAM</h2><p>You can go further with SAM by using just functions. Please read second part <a href="/2017/03/20/Further-than-SAM/"><strong>here</strong></a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://red-green-rewrite.github.io/2017/03/12/You-are-better-off-with-SAM/" data-id="cj0iyigu2000gscjbzdyweguh" class="article-share-link">Share</a>
      
        <a href="http://red-green-rewrite.github.io/2017/03/12/You-are-better-off-with-SAM/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csharp/">csharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/design/">design</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functional/">functional</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/03/20/Further-than-SAM/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Further than SAM
        
      </div>
    </a>
  
  
    <a href="/2016/10/30/Kruskal-DFS-hybrid-with-reduced-branching-factor/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Kruskal/DFS hybrid with reduced branching factor</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/">csharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fable/">fable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fsharp/">fsharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/functional/">functional</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kata/">kata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-js/">kotlin.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maze/">maze</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala-js/">scala.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/state-machine/">state-machine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/">tree</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/csharp/" style="font-size: 15px;">csharp</a> <a href="/tags/design/" style="font-size: 12.5px;">design</a> <a href="/tags/fable/" style="font-size: 12.5px;">fable</a> <a href="/tags/fsharp/" style="font-size: 17.5px;">fsharp</a> <a href="/tags/functional/" style="font-size: 12.5px;">functional</a> <a href="/tags/kata/" style="font-size: 10px;">kata</a> <a href="/tags/kotlin/" style="font-size: 15px;">kotlin</a> <a href="/tags/kotlin-js/" style="font-size: 12.5px;">kotlin.js</a> <a href="/tags/maze/" style="font-size: 17.5px;">maze</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/scala-js/" style="font-size: 10px;">scala.js</a> <a href="/tags/state-machine/" style="font-size: 10px;">state-machine</a> <a href="/tags/tree/" style="font-size: 10px;">tree</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/20/Further-than-SAM/">Further than SAM</a>
          </li>
        
          <li>
            <a href="/2017/03/12/You-are-better-off-with-SAM/">You are better off with SAM</a>
          </li>
        
          <li>
            <a href="/2016/10/30/Kruskal-DFS-hybrid-with-reduced-branching-factor/">Kruskal/DFS hybrid with reduced branching factor</a>
          </li>
        
          <li>
            <a href="/2016/10/06/Kruskal-Kotlin-and-Hex-Tiles/">Kruskal, Kotlin, and Hex Tiles</a>
          </li>
        
          <li>
            <a href="/2016/09/30/Curious-case-of-disjoint-set/">Curious case of disjoint-set</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Milosz Krajewski<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'red-green-rewrite';
  
  var disqus_url = 'http://red-green-rewrite.github.io/2017/03/12/You-are-better-off-with-SAM/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>