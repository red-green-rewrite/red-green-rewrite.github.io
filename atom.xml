<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Red, Green, Rewrite</title>
  <subtitle>the tales about software development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://red-green-rewrite.github.io/"/>
  <updated>2016-09-14T19:23:29.950Z</updated>
  <id>http://red-green-rewrite.github.io/</id>
  
  <author>
    <name>Milosz Krajewski</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Maze generator with Fable</title>
    <link href="http://red-green-rewrite.github.io/2016/09/14/Maze-generator-with-Fable/"/>
    <id>http://red-green-rewrite.github.io/2016/09/14/Maze-generator-with-Fable/</id>
    <published>2016-09-14T19:53:39.000Z</published>
    <updated>2016-09-14T19:23:29.950Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Quick-links&quot;&gt;&lt;a href=&quot;#Quick-links&quot; class=&quot;headerlink&quot; title=&quot;Quick links&quot;&gt;&lt;/a&gt;Quick links&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/MiloszKrajewski/fable-daedalus&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Source code&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dl.dropboxusercontent.com/u/317815/daedalus/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Online demo&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Redgate’s-first-ever-coding-challenge&quot;&gt;&lt;a href=&quot;#Redgate’s-first-ever-coding-challenge&quot; class=&quot;headerlink&quot; title=&quot;Redgate’s first ever coding challenge&quot;&gt;&lt;/a&gt;Redgate’s first ever coding challenge&lt;/h2&gt;&lt;p&gt;For quite some time I was looking for excuse to use &lt;a href=&quot;https://fable-compiler.github.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Fable&lt;/a&gt;. Fable is &lt;a href=&quot;http://fsharp.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;F#&lt;/a&gt; to JavaScript compiler. I generally shy away from JavaScript, as I am biased towards backend but as a big fan of F# I wanted to play a little with Fable (and &lt;a href=&quot;https://www.scala-js.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Scala.js&lt;/a&gt; actually). On top of that, I wanted to try some other technologies I’ve never used before: &lt;a href=&quot;https://github.com/Matt-Esch/virtual-dom&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;VirtualDom&lt;/a&gt; (maybe &lt;a href=&quot;https://facebook.github.io/react/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;React&lt;/a&gt;), &lt;a href=&quot;https://webpack.github.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Webpack&lt;/a&gt;, &lt;a href=&quot;http://www.pixijs.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Pixi.js&lt;/a&gt;. All I needed was an excuse…&lt;/p&gt;
&lt;p&gt;I’ve found &lt;a href=&quot;http://www.red-gate.com/our-company/entrypage/coding-challenge&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Redgate’s first ever coding challenge&lt;/a&gt; on LinkedIn and I decided to do it with Fable in the browser. The challenge is about writing an application to generate mazes (thus the Daedalus reference). I wasn’t going to apply as my solution is probably the most trivial one using “randomized DFS”, so there is nothing to show off, but, I wanted to use those tools.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;EDIT&lt;/em&gt;: eventually, it did apply&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/daedalus/maze-100x100.png&quot; alt=&quot;100x100&quot;&gt;  &lt;/p&gt;
&lt;p&gt;Initially solution was building SVG with VirtualDOM. It was very neat as Fable/VirtualDOM uses &lt;a href=&quot;http://elm-lang.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Elm&lt;/a&gt; architecture (check Fable &lt;a href=&quot;https://fable-compiler.github.io/samples/virtualdom/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;samples page&lt;/a&gt;). It was fast enough to solve the problem but unfortunatelly, for bigger mazes (&amp;gt;50x50), not fast enough for live animation. Changing multiple &lt;code&gt;&amp;lt;rect&amp;gt;&lt;/code&gt; to one long multipart &lt;code&gt;&amp;lt;path&amp;gt;&lt;/code&gt; made it a little bit faster (~20%) but it still wasn’t good enough and it was definitely slowing down further it went.&lt;/p&gt;
&lt;p&gt;The final version is not as ambitious, uses &lt;a href=&quot;https://jquery.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;jQuery&lt;/a&gt; and &lt;a href=&quot;http://projects.calebevans.me/jcanvas/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;jCanvas&lt;/a&gt;. Presentation layer is very old school, but it works and is very fast (relatively speaking, of course). Note, I could deal with the &lt;code&gt;&amp;lt;canvas&amp;gt;&lt;/code&gt; without any supporting libraries, but one of my goals was to investigate and evaluate integration with native JavaScript libraries as, in my opinion, integration is one of the most important aspects of any X-to-JavaScript transpiler.     &lt;/p&gt;
&lt;h2 id=&quot;“You’re-very-clever-young-man-very-clever-”-said-the-old-lady-“But-it’s-functions-all-the-way-down-”&quot;&gt;&lt;a href=&quot;#“You’re-very-clever-young-man-very-clever-”-said-the-old-lady-“But-it’s-functions-all-the-way-down-”&quot; class=&quot;headerlink&quot; title=&quot;“You’re very clever, young man, very clever,” said the old lady. “But it’s functions all the way down!”&quot;&gt;&lt;/a&gt;“You’re very clever, young man, very clever,” said the old lady. “But it’s functions all the way down!”&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://vimeo.com/113588389&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Scott Wlaschin&lt;/a&gt; says “No abstraction is too small”. I agree, I’m a big fan of “extracting abstraction” and I’m so glad F# supports and encourages local one-liners. I believe problems should be decomposed into small managable chunks first and then composed back into solution. Things should be named appropriately as well. Let me use example given by &lt;a href=&quot;https://vimeo.com/97329157&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kevlin Henney&lt;/a&gt; (it’s actually Dan North’s example but I have no link): &lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (portfolioIdsByTraderId.get(trader.getId()).containsKey(portfolio.getId())) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Even if we understand every single word in this statement, it is still unclear what purpose it serves. It is not abstract enough, it contains too much of “implementation”. Maybe we should consider this as an alternative:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (trader.canView(portfolio)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Yup, that’s much better.&lt;/p&gt;
&lt;p&gt;For every solution, at some point there will be a need for some “ugly implementation details”. It is just nicer when you can push it far away from business logic so it does not get in a way when you try to reason about what this code “actually does”.&lt;/p&gt;
&lt;p&gt;In this article I will use a some one-liners. They might seem like overkill for this task but this is primarily fun project and using them is fun!&lt;/p&gt;
&lt;h2 id=&quot;The-algorithm&quot;&gt;&lt;a href=&quot;#The-algorithm&quot; class=&quot;headerlink&quot; title=&quot;The algorithm&quot;&gt;&lt;/a&gt;The algorithm&lt;/h2&gt;&lt;p&gt;There are few algorithms listed on &lt;a href=&quot;https://en.wikipedia.org/wiki/Maze_generation_algorithm&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Wikipedia&lt;/a&gt; and randomized depth-first search is probably the simplest one. &lt;/p&gt;
&lt;p&gt;It has two disadvantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;solution has a low branching factor and contain many long corridors&lt;/li&gt;
&lt;li&gt;solution does not contain cycles - of course, cycles can be seen as shortcuts, therefore making it easier for potential adventurer, but also they open the door “to be lost forever”, making it infinitely harder. Trade-offs, as usual. &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’m going to decompose the solution into smaller pieces instead of using single monolithic function. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A physicist and a mathematician setting in a faculty lounge. Suddenly, the coffee machine catches on fire. The physicist grabs a bucket and leaps towards the sink, fills the bucket with water and puts out the fire. The second day, the same two sit in the same lounge. Again, the coffee machine catches on fire. This time, the mathematician stands up, gets a bucket, hands the bucket to the physicist, thus reducing the problem to a previously solved one. &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Let’s start with generic depth-first search then:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; DFS =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// (&#39;T -&amp;gt; unit) -&amp;gt; (&#39;T -&amp;gt; bool) -&amp;gt; (&#39;T -&amp;gt; &#39;T seq) -&amp;gt; &#39;T -&amp;gt; T&#39; seq&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;rec&lt;/span&gt; traverse mark test fanout node =  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        seq &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; node |&amp;gt; test &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            | &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt; -&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;yield&lt;/span&gt; node |&amp;gt; apply mark&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;yield!&lt;/span&gt; node |&amp;gt; fanout |&amp;gt; Seq.collect (traverse mark test fanout)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            | _ -&amp;gt; ()  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;where &lt;code&gt;mark: &amp;#39;T -&amp;gt; unit&lt;/code&gt; is the function which will take a node and mark it as visited, &lt;code&gt;test: &amp;#39;T -&amp;gt; bool&lt;/code&gt; will test is node has been visisted already, &lt;code&gt;fanout: &amp;#39;T -&amp;gt; &amp;#39;T seq&lt;/code&gt; will take a node and return a sequence of connected nodes (neighbours?) and finally &lt;code&gt;node: &amp;#39;T&lt;/code&gt; is just a starting point.&lt;/p&gt;
&lt;p&gt;The algorithm goes like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;if node has not been visited yet (&lt;code&gt;node |&amp;gt; test&lt;/code&gt;) mark it as visisted (&lt;code&gt;apply mark&lt;/code&gt;) and return it (&lt;code&gt;yield&lt;/code&gt;). &lt;/li&gt;
&lt;li&gt;for every connected node (&lt;code&gt;node |&amp;gt; fanout&lt;/code&gt;), rinse and repeat (&lt;code&gt;Seq.collect traverse mark test fanout&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you don’t know what &lt;code&gt;apply&lt;/code&gt; does I would recommend my &lt;a href=&quot;/2016/09/14/Use-apply-and-carry-on/&quot;&gt;other post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Done. We can go home… OK, I’m just joking.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;NOTE&lt;/em&gt;: This solution is vulnerable to stack overflow as it goes deeper and deeper with every visited node. The &lt;a href=&quot;https://github.com/MiloszKrajewski/fable-daedalus&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;actual solution&lt;/a&gt; uses different implementation of DFS which is using &lt;code&gt;while&lt;/code&gt; loop and lists to simulate call stack (I called it &lt;code&gt;stackless&lt;/code&gt; which is a little self contradicting, isn’t it?). Idea is absolutely the same though, but code is less elegant.&lt;/p&gt;
&lt;h2 id=&quot;The-domain&quot;&gt;&lt;a href=&quot;#The-domain&quot; class=&quot;headerlink&quot; title=&quot;The domain&quot;&gt;&lt;/a&gt;The domain&lt;/h2&gt;&lt;p&gt;So, we have an algorithms. Now we need domain model.&lt;/p&gt;
&lt;p&gt;Initially, the domain of this problem consisted of the &lt;code&gt;World&lt;/code&gt;, which is a collection of &lt;code&gt;Rooms&lt;/code&gt; which in turn have their &lt;code&gt;Location&lt;/code&gt; and are connected (or not) through &lt;code&gt;Exits&lt;/code&gt;. Not all of those concepts are needed for the algorithm. They may or may not be needed by presentation layer but we probably shouldn’t jump ahead, I guess.  &lt;/p&gt;
&lt;p&gt;So, let’s start with &lt;code&gt;Location&lt;/code&gt; (x and y coordinates) and &lt;code&gt;Direction&lt;/code&gt; (north, east, etc…):&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Location&lt;/span&gt; &lt;/span&gt;= int * int&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Direction&lt;/span&gt; &lt;/span&gt;= | North | East | South | West&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;There is also a relation between &lt;em&gt;directions&lt;/em&gt; (&lt;code&gt;opposite&lt;/code&gt;) and a function allowing to move from one &lt;em&gt;location&lt;/em&gt; in given &lt;em&gt;direction&lt;/em&gt; (&lt;code&gt;shift&lt;/code&gt;).  &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; opposite direction = &lt;span class=&quot;comment&quot;&gt;// Direction -&amp;gt; Direction &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; direction &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | North -&amp;gt; South | South -&amp;gt; North &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | West -&amp;gt; East | East -&amp;gt; West&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; shift (x, y) direction = &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; Direction -&amp;gt; Location&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; direction &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | North -&amp;gt; (x, y - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) | South -&amp;gt; (x, y + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | East -&amp;gt; (x + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, y) | West -&amp;gt; (x - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, y)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Traversing a maze is about &lt;em&gt;actions&lt;/em&gt; (or moves). Theoretically, we could model it with single type of action (&lt;em&gt;move south from 5,4 to 5,5&lt;/em&gt;), but first move (which is &lt;em&gt;start at 0,0&lt;/em&gt;) does not have source nor direction and with language like F# you should not compromise on domain model aka &lt;a href=&quot;(https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/&quot;&gt;make illegal state unrepresentable&lt;/a&gt;.&lt;br&gt;So, I ended up with two possible actions: &lt;em&gt;teleporting to starting location&lt;/em&gt; and &lt;em&gt;moving from one location to another&lt;/em&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Action&lt;/span&gt; &lt;/span&gt;=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | InitAt &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; Location&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | MoveTo &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; Location * Direction * Location&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The &lt;code&gt;Action&lt;/code&gt; has it’s “property” called target, the &lt;code&gt;Location&lt;/code&gt; where it ends:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Action -&amp;gt; Location&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; targetOf action = &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; action &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | InitAt location -&amp;gt; location &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | MoveTo (_, _, location) -&amp;gt; location&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;Bringing-“The-algorithm”-and-“The-domain”-together&quot;&gt;&lt;a href=&quot;#Bringing-“The-algorithm”-and-“The-domain”-together&quot; class=&quot;headerlink&quot; title=&quot;Bringing “The algorithm” and “The domain” together&quot;&gt;&lt;/a&gt;Bringing “The algorithm” and “The domain” together&lt;/h2&gt;&lt;p&gt;It is important to realize, that DFS in this case does not really traverse &lt;em&gt;rooms&lt;/em&gt; (graph nodes), it actually traverses &lt;em&gt;actions&lt;/em&gt; (graph edges), although it is the &lt;em&gt;room&lt;/em&gt; which is visted (not &lt;em&gt;action&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;Long story short, there is some glue needed between “The algorithm” and “The domain” presented above.&lt;/p&gt;
&lt;p&gt;Let’s start with some one-liners for solution:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// int -&amp;gt; int -&amp;gt; Action seq&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; buildMaze width height =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; bool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; isValid (x, y) = x &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; y &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; x &amp;lt; width &amp;amp;&amp;amp; y &amp;lt; height&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; visited = HashSet()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; encode (x, y) = y*width + x &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; unit &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; mark location = location |&amp;gt; encode |&amp;gt; visited.Add |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; bool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; test location = location |&amp;gt; encode |&amp;gt; visited.Contains&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;em&gt;NOTE&lt;/em&gt;: &lt;code&gt;HashSet&lt;/code&gt; in Fable is modelled using JavaScript &lt;code&gt;Set&lt;/code&gt; which does not use structural equality (I learnt it the hard way). Therefore two identical tuples would not be recognised as such. We need to &lt;code&gt;encode&lt;/code&gt; tuple value as something which is properly handled by &lt;code&gt;Set&lt;/code&gt;. Encoding tuple as single &lt;code&gt;int&lt;/code&gt; is one options, encoding it as &lt;code&gt;string&lt;/code&gt; would be also valid (but a little but slower, I suppose).&lt;/p&gt;
&lt;p&gt;We have function to test is given &lt;em&gt;location&lt;/em&gt; is valid for given maze size (&lt;code&gt;isValid&lt;/code&gt;), we can test if &lt;em&gt;action&lt;/em&gt; points to a &lt;em&gt;room&lt;/em&gt; which has been &lt;em&gt;visisted&lt;/em&gt; before (&lt;code&gt;test&lt;/code&gt;) and mark the &lt;em&gt;location&lt;/em&gt; as &lt;em&gt;visisted&lt;/em&gt; if needed (&lt;code&gt;mark&lt;/code&gt;). That is just a small vocabulary for our problem.&lt;/p&gt;
&lt;p&gt;It’s time to define &lt;code&gt;fanout&lt;/code&gt; method which will return all valid the neighbours: &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; Action seq&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; fanout source =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [| West; North; East; South |] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    |&amp;gt; Array.map (&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; direction -&amp;gt; MoveTo (source, direction, shift source direction))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    |&amp;gt; Array.filter (targetOf &amp;gt;&amp;gt; isValid)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;As you can see, it takes a &lt;em&gt;source location&lt;/em&gt;, then generates a sequence of &lt;code&gt;MoveTo&lt;/code&gt; &lt;em&gt;actions&lt;/em&gt; in every direction and then eliminates the ones with invalid &lt;em&gt;target locations&lt;/em&gt; (the ones which would point outside the maze). You may wonder why &lt;code&gt;fanout&lt;/code&gt; returns candidates in pretty deterministic order. And that’s fair question. I just don’t think randomization stategy is responsibility of &lt;code&gt;fanout&lt;/code&gt; function, I think we can postpone this decision (at least for 5 more seconds).&lt;/p&gt;
&lt;p&gt;We have all building blocks ready now and it’s time to call &lt;code&gt;DFS.traverse&lt;/code&gt; (or &lt;code&gt;DFS.stackless&lt;/code&gt;). As I said before &lt;code&gt;traverse&lt;/code&gt; operate on &lt;em&gt;actions&lt;/em&gt; (not &lt;em&gt;locations&lt;/em&gt;), and functions we defined so far work on &lt;em&gt;locations&lt;/em&gt;. We will need some adapters, and some randomization of &lt;code&gt;fanout&lt;/code&gt; output.&lt;/p&gt;
&lt;p&gt;Functional composition to the rescue: &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;InitAt (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&amp;gt; DFS.traverse (targetOf &amp;gt;&amp;gt; mark) (targetOf &amp;gt;&amp;gt; test) (targetOf &amp;gt;&amp;gt; fanout &amp;gt;&amp;gt; Array.shuffle)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;It starts with &lt;em&gt;action&lt;/em&gt; (&lt;code&gt;InitAt (0, 0)&lt;/code&gt;), and uses composition to adapt input argument of &lt;code&gt;mark&lt;/code&gt;, &lt;code&gt;test&lt;/code&gt; and &lt;code&gt;fanout&lt;/code&gt;. It also randomizes the output of &lt;code&gt;fanout&lt;/code&gt; with &lt;code&gt;shuffle&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;And this sequence of &lt;em&gt;actions&lt;/em&gt; it the result of &lt;code&gt;buildMaze&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Done, again. OK, we need presentation.&lt;/p&gt;
&lt;h2 id=&quot;Presentation&quot;&gt;&lt;a href=&quot;#Presentation&quot; class=&quot;headerlink&quot; title=&quot;Presentation&quot;&gt;&lt;/a&gt;Presentation&lt;/h2&gt;&lt;p&gt;Without getting into much details we need a &lt;code&gt;&amp;lt;button&amp;gt;&lt;/code&gt; and a &lt;code&gt;&amp;lt;canvas&amp;gt;&lt;/code&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;button&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;restart&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;button&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;btn&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;Restart&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;button&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;canvas&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;canvas&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;maze&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;canvas&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;That’s the UI. Right? Yeah, kind of. Be aware that the code here is for illustration only, please refer to &lt;a href=&quot;https://github.com/MiloszKrajewski/fable-daedalus&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github&lt;/a&gt; for actual working sources.&lt;/p&gt;
&lt;p&gt;Let’s start with importing native JavaScript libraries: &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; jq = importDefault&amp;lt;obj&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;jquery&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(importDefault&amp;lt;obj&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;jcanvas&quot;&lt;/span&gt;) $ (jq, Browser.window) |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;As you can see there a little bit weird syntax when accessing arbitrary JavaScript objects. The good news is you can &lt;a href=&quot;https://www.npmjs.com/package/ts2fable&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;import&lt;/a&gt; &lt;a href=&quot;https://github.com/DefinitelyTyped/DefinitelyTyped&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TypeScript&lt;/a&gt; &lt;code&gt;.d.ts&lt;/code&gt; definition files into Fable to have strongly typed interfaces. In this case though, I used so little of it, that I could manage dynamic invocation.&lt;/p&gt;
&lt;p&gt;Long story short, &lt;code&gt;importDefault&lt;/code&gt; get’s translated into &lt;code&gt;require&lt;/code&gt; (for &lt;code&gt;CommonJS&lt;/code&gt;). The &lt;code&gt;$&lt;/code&gt; operator is &lt;em&gt;invoke&lt;/em&gt;, &lt;code&gt;?&lt;/code&gt; operator is &lt;em&gt;get&lt;/em&gt; and &lt;code&gt;&amp;lt;-&lt;/code&gt; is &lt;em&gt;set&lt;/em&gt;. &lt;code&gt;$&lt;/code&gt; operator in many cases can be ommited.&lt;br&gt;So, &lt;code&gt;a ? b ? c(77)&lt;/code&gt; would be translated to &lt;code&gt;a.b.c(77);&lt;/code&gt; while &lt;code&gt;a ? b ? c &amp;lt;- 11&lt;/code&gt; would be translated to &lt;code&gt;a.b.c = 11;&lt;/code&gt;. &lt;/p&gt;
&lt;p&gt;Please note, that as there is an assumptions that everything returns &lt;code&gt;obj&lt;/code&gt; (or &lt;code&gt;obj -&amp;gt; obj&lt;/code&gt; which is also an &lt;code&gt;obj&lt;/code&gt;). F# does not like dangling result values so you need to &lt;code&gt;ignore&lt;/code&gt; results you don’t care about. I definitely recommend referring to Fable website for more details.&lt;/p&gt;
&lt;p&gt;Let’s define some constants:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; WORLD_WIDTH = &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; WORLD_HEIGHT = &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; ROOM_SIZE = &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; DOOR_SIZE = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; ROOM_COLOR = &lt;span class=&quot;string&quot;&gt;&quot;#fff&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;[&amp;lt;Literal&amp;gt;]&lt;/span&gt; DOOR_COLOR = &lt;span class=&quot;string&quot;&gt;&quot;#eee&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;and a simple function to convert world &lt;em&gt;location&lt;/em&gt; to coordinates in pixels:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; toPixel (x, y) = &lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; (int * int) // and yes, I&#39;m cheting with types a little&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x*ROOM_SIZE + (x + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)*DOOR_SIZE, y*ROOM_SIZE + (y + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)*DOOR_SIZE&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Let’s set the &lt;code&gt;&amp;lt;canvas&amp;gt;&lt;/code&gt; up, by setting &lt;code&gt;width&lt;/code&gt;, &lt;code&gt;height&lt;/code&gt;, &lt;code&gt;viewbox&lt;/code&gt; and &lt;code&gt;viewport&lt;/code&gt; (using jQuery):&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; w, h = toPixel (WORLD_WIDTH, WORLD_HEIGHT)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; canvas = jq $ (&lt;span class=&quot;string&quot;&gt;&quot;#canvas&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;canvas &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ? attr(&lt;span class=&quot;string&quot;&gt;&quot;width&quot;&lt;/span&gt;, w) ? attr(&lt;span class=&quot;string&quot;&gt;&quot;height&quot;&lt;/span&gt;, h) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ? attr(&lt;span class=&quot;string&quot;&gt;&quot;viewbox&quot;&lt;/span&gt;, sprintf &lt;span class=&quot;string&quot;&gt;&quot;0 0 %d %d&quot;&lt;/span&gt; w h) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ? attr(&lt;span class=&quot;string&quot;&gt;&quot;viewport&quot;&lt;/span&gt;, sprintf &lt;span class=&quot;string&quot;&gt;&quot;0 0 %d %d&quot;&lt;/span&gt; w h) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;and wire &lt;code&gt;click&lt;/code&gt; event on “Restart” button:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; cancel = id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; button = jq $ (&lt;span class=&quot;string&quot;&gt;&quot;#restart&quot;&lt;/span&gt;)  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;button ? click(&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; _ -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cancel ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    canvas ? clearCanvas () |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cancel &amp;lt;- startAnimation canvas&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;) |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The thing with &lt;code&gt;cancel&lt;/code&gt; might be a little bit unclear. Function &lt;code&gt;startAnimation&lt;/code&gt; will return a function (function returning function, yes) which can be called to cancel animation. So next time &lt;code&gt;Restart&lt;/code&gt; button is pressed previous animation will be cancelled before starting new one. To avoid &lt;code&gt;null&lt;/code&gt; (or &lt;code&gt;None&lt;/code&gt;) checking (on first run) &lt;code&gt;cancel&lt;/code&gt; just gets initialized with function which does nothing (yes, &lt;code&gt;id&lt;/code&gt; is a function which does nothing).&lt;/p&gt;
&lt;p&gt;Back to solution, when button is pressed potential old animation is cancelled (&lt;code&gt;cancel()&lt;/code&gt;), canvas is cleared (&lt;code&gt;canvas ? clearCanvas () |&amp;gt; ignore&lt;/code&gt;) and new animation is started (&lt;code&gt;cancel &amp;lt;- startAnimation canvas&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;There is only one method left, then:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; startAnimation canvas = &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Please note, the code below in the scope of &lt;code&gt;startAnimation&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We will definitely need to draw rectangles on canvas, and that’s kind of all we are going to do. I will use &lt;code&gt;jCanvas&lt;/code&gt; to do this, but it is an overkill, of course, it could (and should?) be done with browser API, but I’m exploring here, right?&lt;br&gt;As with dynamic invocation eveything is &lt;code&gt;obj&lt;/code&gt; we want to add some types when JavaScript and Fable meets. Let’s wrap &lt;code&gt;jCanvas.drawRect&lt;/code&gt; first into &lt;code&gt;drawBox&lt;/code&gt; function:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; drawBox (color: string) (x: int) (y: int) (w: int) (h: int) =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; rect = &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        createObj [ &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;fillStyle&quot;&lt;/span&gt; ==&amp;gt; color; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;x&quot;&lt;/span&gt; ==&amp;gt; x; &lt;span class=&quot;string&quot;&gt;&quot;y&quot;&lt;/span&gt; ==&amp;gt; y; &lt;span class=&quot;string&quot;&gt;&quot;width&quot;&lt;/span&gt; ==&amp;gt; w; &lt;span class=&quot;string&quot;&gt;&quot;height&quot;&lt;/span&gt; ==&amp;gt; h; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;fromCenter&quot;&lt;/span&gt; ==&amp;gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    canvas ? drawRect(rect) |&amp;gt; ignore&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Yup. Done. Not pretty but done. We can forget about this traumatic experience now. It actually generates quite readable code:&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; rect = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fillStyle: color,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x: x,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    y: y,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    width: w,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    height: h,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fromCenter: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;canvas.drawRect(rect);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;From now on, we can forget about JavaScript interop again. We can just use &lt;code&gt;drawBox&lt;/code&gt; and implement &lt;code&gt;drawRoom&lt;/code&gt; to draw a room, and &lt;code&gt;drawDoor&lt;/code&gt; to draw a door: &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; unit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; drawRoom location =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; x, y = toPixel location &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; drawBox ROOM_COLOR x y ROOM_SIZE ROOM_SIZE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Location -&amp;gt; Direction -&amp;gt; unit    &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; drawDoor location direction =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; x, y = toPixel location&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; direction &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | North -&amp;gt; drawBox DOOR_COLOR x (y - DOOR_SIZE) ROOM_SIZE DOOR_SIZE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | South -&amp;gt; drawBox DOOR_COLOR x (y + ROOM_SIZE) ROOM_SIZE DOOR_SIZE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | East -&amp;gt; drawBox DOOR_COLOR (x + ROOM_SIZE) y DOOR_SIZE ROOM_SIZE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | West -&amp;gt; drawBox DOOR_COLOR (x - DOOR_SIZE) y DOOR_SIZE ROOM_SIZE&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;Room&lt;/code&gt; is drawn as big square, while &lt;code&gt;Door&lt;/code&gt; is just a slim rectangle (depends on relation between &lt;code&gt;DOOR_SIZE&lt;/code&gt; and &lt;code&gt;ROOM_SIZE&lt;/code&gt;). As you can see doors have different shape depending on direction (for example: North vs East).&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/daedalus/maze-5x5.png&quot; alt=&quot;5x5&quot;&gt;&lt;/p&gt;
&lt;p&gt;Now, we need to start traversing the maze:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; action = buildMaze WORLD_WIDTH WORLD_HEIGHT |&amp;gt; Enumerator.create&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;You can notice &lt;code&gt;Enumerator&lt;/code&gt; here, which might be a little bit cryptic but it just provides slighlty more F#-ish way to use &lt;code&gt;IEnumerable&amp;lt;T&amp;gt;&lt;/code&gt; interface. &lt;/p&gt;
&lt;p&gt;The last part is the animation loop, we need to draw actions as they come. Let’s schedule a callback every 1/60th of a second (should I use &lt;code&gt;requestAnimationFrame&lt;/code&gt; here?) which will take current frame (well… &lt;em&gt;action&lt;/em&gt;), draw adequate objects (&lt;code&gt;drawRoom&lt;/code&gt; and &lt;code&gt;drawDoor&lt;/code&gt;) and then proceed to next &lt;em&gt;action&lt;/em&gt; (&lt;code&gt;action &amp;lt;- action |&amp;gt; Option.bind Enumerator.next&lt;/code&gt;):&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; cancel = id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cancel &amp;lt;- Time.interval (&lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt; / &lt;span class=&quot;number&quot;&gt;60.0&lt;/span&gt;) (&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; _ -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; action |&amp;gt; Option.map Enumerator.value &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | None -&amp;gt; cancel ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Some (InitAt location) -&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        drawRoom location&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Some (MoveTo (_, direction, location)) -&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        drawRoom location&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        drawDoor location (opposite direction)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    action &amp;lt;- action |&amp;gt; Option.bind Enumerator.next &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cancel&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The last line returns &lt;code&gt;cancel&lt;/code&gt; (returns a function, but does not call it) from &lt;code&gt;startAnimation&lt;/code&gt; so animation can be externally cancelled.&lt;br&gt;Note: &lt;code&gt;Time.interval&lt;/code&gt; is just a wrapper for &lt;code&gt;setInterval&lt;/code&gt; and &lt;code&gt;clearInterval&lt;/code&gt; to have more F#-ish experience:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; Time =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;open&lt;/span&gt; Fable.Import.Browser&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// float -&amp;gt; (unit -&amp;gt; unit) -&amp;gt; (unit -&amp;gt; unit)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; interval seconds (action: unit -&amp;gt; unit) =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; disposable = window.setInterval (action, seconds / &lt;span class=&quot;number&quot;&gt;1000.0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; () -&amp;gt; window.clearInterval(disposable)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;I guess that’s it.&lt;/p&gt;
&lt;p&gt;You can find solution on &lt;a href=&quot;https://github.com/MiloszKrajewski/fable-daedalus&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github&lt;/a&gt;. It actually has many branches as I was trying many approaches. I started with “Immutable domain with VirtualDOM to generate SVG”, then I switched to “Mutable domain with VirtualDOM to generate SVG paths”, then I switched to “Mutable domain with jCanvas” and then I realized that half of domain was actually needed by VirtualDOM approach only. So, last incarnation if Daedalus is “Mutable mini domain with jCanvas”. &lt;/p&gt;
&lt;p&gt;If you want to just see it work, you can find it &lt;a href=&quot;https://dl.dropboxusercontent.com/u/317815/daedalus/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Thanks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://fable-compiler.github.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Fable&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://webpack.github.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Webpack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://code.visualstudio.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Visual Studio Code&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://ionide.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Ionide&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://cmder.net/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Cmder&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Quick-links&quot;&gt;&lt;a href=&quot;#Quick-links&quot; class=&quot;headerlink&quot; title=&quot;Quick links&quot;&gt;&lt;/a&gt;Quick links&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/
    
    </summary>
    
    
      <category term="f#" scheme="http://red-green-rewrite.github.io/tags/f/"/>
    
      <category term="fable" scheme="http://red-green-rewrite.github.io/tags/fable/"/>
    
      <category term="webpack" scheme="http://red-green-rewrite.github.io/tags/webpack/"/>
    
      <category term="graph" scheme="http://red-green-rewrite.github.io/tags/graph/"/>
    
  </entry>
  
  <entry>
    <title>Use apply and carry on</title>
    <link href="http://red-green-rewrite.github.io/2016/09/14/Use-apply-and-carry-on/"/>
    <id>http://red-green-rewrite.github.io/2016/09/14/Use-apply-and-carry-on/</id>
    <published>2016-09-14T17:47:16.000Z</published>
    <updated>2016-09-14T17:20:38.636Z</updated>
    
    <content type="html">&lt;p&gt;One of everyone’s favourite features of F# is pipe (&lt;code&gt;|&amp;gt;&lt;/code&gt;) operator. It allows to pipe output of one function as input to another function preserving &lt;a href=&quot;http://theburningmonk.com/2014/12/being-visually-honest-with-f/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;visual honesty&lt;/a&gt;. The general idea is that, in English, we read &lt;em&gt;left-to-right&lt;/em&gt; and &lt;em&gt;top-down&lt;/em&gt;. In C# (C, C++, Java, Pascal, Python) we read in all possible directions, most likely &lt;em&gt;top-down&lt;/em&gt; for overall structure but &lt;em&gt;botton-up&lt;/em&gt; and &lt;em&gt;right-to-left&lt;/em&gt; for single statements.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://theburningmonk.com/WordPress/wp-content/uploads/2015/03/visual_dishonesty.png&quot; alt=&quot;Visual honesty&quot;&gt;&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = Math.Round(Math.Exp(Math.Sin(x*&lt;span class=&quot;number&quot;&gt;5.2&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;7.1&lt;/span&gt;)));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;starts at the &lt;em&gt;right&lt;/em&gt; end going &lt;em&gt;left-to-right&lt;/em&gt; for a moment (&lt;code&gt;x*5.2 + 7.1&lt;/code&gt;) but then turns &lt;em&gt;right-to-left&lt;/em&gt; with &lt;code&gt;Math.Sin&lt;/code&gt;, &lt;code&gt;Math.Exp&lt;/code&gt; and finally &lt;code&gt;Math.Round&lt;/code&gt; (in this order). In F# the pipe operator (&lt;code&gt;|&amp;gt;&lt;/code&gt;) allows to write code exactly in the same order as it is going to be executed:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; y = x*&lt;span class=&quot;number&quot;&gt;5.2&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;7.1&lt;/span&gt; |&amp;gt; Math.Sin |&amp;gt; Math.Exp |&amp;gt; Math.Round&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Around the world, many hours have been spent arranging function arguments (guilty!) to allow such seamless experience. But sometimes, the universe is against us. Let’s assume we would like to print out the value after &lt;code&gt;Math.Sin&lt;/code&gt;. The conservative approach would be quite intrusive - we would need to break expression in half:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; temp = x*&lt;span class=&quot;number&quot;&gt;5.2&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;7.1&lt;/span&gt; |&amp;gt; Math.Sin &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;printf &lt;span class=&quot;string&quot;&gt;&quot;%g&quot;&lt;/span&gt; temp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; y = temp |&amp;gt; Math.Exp |&amp;gt; Math.Round&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Whoa! That is intrusive. &lt;/p&gt;
&lt;p&gt;But here comes the rescue. The &lt;code&gt;apply&lt;/code&gt; function implemented as:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; apply func arg = func arg; arg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The function itself is trivial, it takes a function and an argument, executes given function with given argument but then returns it, so the argument goes through the function: &lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; y = x*&lt;span class=&quot;number&quot;&gt;5.2&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;7.1&lt;/span&gt; |&amp;gt; Math.Sin |&amp;gt; apply (printf &lt;span class=&quot;string&quot;&gt;&quot;%g&quot;&lt;/span&gt;) |&amp;gt; Math.Exp |&amp;gt; Math.Round&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;In the example above, the function (&lt;code&gt;printf &amp;quot;%g&amp;quot;&lt;/code&gt;) has been &lt;em&gt;applied&lt;/em&gt; to a value passed between &lt;code&gt;Math.Sin&lt;/code&gt; and &lt;code&gt;Math.Exp&lt;/code&gt; but did not require any temporary variables or breaking the flow.&lt;/p&gt;
&lt;p&gt;So, &lt;strong&gt;use apply and carry on&lt;/strong&gt;!&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;One of everyone’s favourite features of F# is pipe (&lt;code&gt;|&amp;gt;&lt;/code&gt;) operator. It allows to pipe output of one function as input to an
    
    </summary>
    
    
      <category term="F#" scheme="http://red-green-rewrite.github.io/tags/F/"/>
    
  </entry>
  
  <entry>
    <title>State Machine Construction Kit for F#</title>
    <link href="http://red-green-rewrite.github.io/2016/06/27/State-Machine-Construction-Kit-for-F/"/>
    <id>http://red-green-rewrite.github.io/2016/06/27/State-Machine-Construction-Kit-for-F/</id>
    <published>2016-06-27T00:46:03.000Z</published>
    <updated>2016-07-11T08:30:35.043Z</updated>
    
    <content type="html">&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: There is a lot of code in this article, as it is repeated and iteratively added. The final version is just 28 lines near the end, but I think you should read the whole thing anyway.&lt;/p&gt;
&lt;p&gt;Once upon the time I needed to implement state machine. To not reinvent the wheel I reviewed what’s available: &lt;a href=&quot;http://msdn.microsoft.com/en-gb/vstudio/jj684582.aspx&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Windows Workflow Foundation&lt;/a&gt;, &lt;a href=&quot;https://github.com/appccelerate/statemachine&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Appccelerate.StateMachine&lt;/a&gt;, &lt;a href=&quot;https://code.google.com/p/bbvcommon/wiki/StateMachineTutorial&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;bbv.Common.StateMachine&lt;/a&gt;, &lt;a href=&quot;https://github.com/nblumhardt/stateless&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Stateless&lt;/a&gt;, &lt;a href=&quot;http://simplestatemachine.codeplex.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SimpleStateMachine&lt;/a&gt;, &lt;a href=&quot;https://code.google.com/p/solid-state&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Solid.State&lt;/a&gt;, and &lt;a href=&quot;https://github.com/OmerMor/StateMachineToolkit/tree/master/src/StateMachineToolkit&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;StateMachineToolkit&lt;/a&gt;. Windows Workflow Foundation was just scary, apart from the fact that State Machine is not available in .NET 4.0. It didn’t look lightweight either.&lt;/p&gt;
&lt;p&gt;None of the others satisfied my requirements either:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Events should be able to carry data&lt;/strong&gt; - for example, hypothetical event &lt;code&gt;KeyPressed&lt;/code&gt; should also carry information which key has been actually pressed;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;States should be able hold data&lt;/strong&gt; - for example, state collecting key presses (let’s call it &lt;code&gt;EnteringText&lt;/code&gt;) should be able to hold a list of keys pressed so far;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Guard statements should have access to both current state and event&lt;/strong&gt; - for example, &lt;code&gt;KeyPressed&lt;/code&gt; event may cause transition to different state depending which key has been pressed;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Transition rules should be implemented outside states&lt;/strong&gt; - states should be more like POCO/DTO object with no logic in them;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’ve implemented it in C#, and I’m relatively happy with it, and you can find it on &lt;a href=&quot;https://github.com/MiloszKrajewski/Stateful&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub&lt;/a&gt;. As an exercise I implemented it for &lt;a href=&quot;https://kotlinlang.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kotlin&lt;/a&gt; as well, also on &lt;a href=&quot;https://github.com/MiloszKrajewski/stateful4k&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub&lt;/a&gt;. Then I had to implement one for work, in Java this time.&lt;/p&gt;
&lt;p&gt;I decided that maybe it’s time to do something for F# community, and implement nice functional State Machine Construction Kit. I dropped the “transition rules should be implemented outside states” requirement as it was adding some messy reflection code.&lt;/p&gt;
&lt;p&gt;To make it more F#y and functional I started with fundamental question: what is the &lt;code&gt;state&lt;/code&gt;? What is its essence?&lt;br&gt;It is actually a function which will take an &lt;code&gt;event&lt;/code&gt; and produce new state:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt; &lt;/span&gt;= &#39;Event -&amp;gt; State&amp;lt;&#39;Event&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;This would actually not compile, because it would create infinite recursive type alias, but:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt; &lt;/span&gt;= | State &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; (&#39;Event -&amp;gt; State)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;will do just fine.&lt;br&gt;Actually it would be a little but nicer if it would be possible to return &lt;code&gt;State option&lt;/code&gt; to handle termination:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt; &lt;/span&gt;= | State &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; (&#39;Event -&amp;gt; State option)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…but, I decided to make it rather with explicit state case:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt; &lt;/span&gt;=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Next &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; (&#39;Event -&amp;gt; State)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Stop&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;So we have transitive state (&lt;code&gt;Next&lt;/code&gt; for &lt;code&gt;State (Some state)&lt;/code&gt;) and terminal state (&lt;code&gt;Stop&lt;/code&gt; for &lt;code&gt;State None&lt;/code&gt;).&lt;br&gt;Please note, that we could add more cases, for example:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;, &lt;span class=&quot;title&quot;&gt;&#39;Result&lt;/span&gt;&amp;gt; &lt;/span&gt;=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Next &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; (&#39;Event -&amp;gt; State)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Stop &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &#39;Result&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Fail &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; Exception&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;but this would introduce some complexity which I don’t want in this example, but you are more than welcome to introduce yourself.&lt;br&gt;So, let’s go back to my State Machine Construction Kit. We already have a state but we also need a function to fire events and transition from state to state, let’s call it &lt;code&gt;feed&lt;/code&gt;, we feed a state with event. It’s actually almost done as state is a transition function:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; feed state event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; state &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Stop -&amp;gt; failwith &lt;span class=&quot;string&quot;&gt;&quot;Terminal state reached&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Next handler -&amp;gt; event |&amp;gt; handler&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;For this example I will use some trivial state machine handling opening and closing doors:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MiloszKrajewski/stateful4k/raw/master/doc/basic-door-machine.png&quot; alt=&quot;simple door state machine&quot;&gt;&lt;/p&gt;
&lt;p&gt;So we have &lt;code&gt;Open&lt;/code&gt; and &lt;code&gt;Close&lt;/code&gt; events:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Event&lt;/span&gt; &lt;/span&gt;= | Open | Close&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…and have two states: &lt;code&gt;opened&lt;/code&gt; and &lt;code&gt;closed&lt;/code&gt;. The states themselves are functions which take events and produce new states:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;rec&lt;/span&gt; opened event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Open -&amp;gt; Next opened&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Close -&amp;gt; printfn &lt;span class=&quot;string&quot;&gt;&quot;closing&quot;&lt;/span&gt;; Next closed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; closed event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Open -&amp;gt; printfn &lt;span class=&quot;string&quot;&gt;&quot;opening&quot;&lt;/span&gt;; Next opened&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    | Close -&amp;gt; Next closed&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Let’s define an initial state, a let’s say it is &lt;code&gt;closed&lt;/code&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; state = Next closed&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Now we can send &lt;code&gt;Open&lt;/code&gt; event to it and store new state:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;state &amp;lt;- Open |&amp;gt; feed state&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Ta-dah! Done.&lt;/p&gt;
&lt;p&gt;Please note, that to handle sequence of events easily, the only thing you need to is to use &lt;code&gt;fold&lt;/code&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;events |&amp;gt; Seq.fold feed state&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;For my personal use I actually created a class to encapsulate mutability. It is, of course, still there but hidden:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;StateMachine&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt;&lt;/span&gt;(initial: State&amp;lt;&#39;Event&amp;gt;) =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; current = initial&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;member&lt;/span&gt; this.Feed event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        current &amp;lt;- feed current event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;member&lt;/span&gt; this.IsStopped&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; get () = &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; current &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; | Stop -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt; | _ -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;What about context (data shared by all states) and state’s state (state internal data) you might ask? By the power of closures and currying there is nothing special to implement. For example, let’s imagine a door state machine which makes sounds (with injected sound emitter) and can be locked or unlocked when closed (state’s internal data):&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Event&lt;/span&gt; &lt;/span&gt;= | Open | Close | Lock | Unlock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; configureDoor sound =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;rec&lt;/span&gt; opened event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Close -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;bang&quot;&lt;/span&gt;; Next (closed &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Lock -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;clack&quot;&lt;/span&gt;; Next opened&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | _ -&amp;gt; Next opened&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; closed locked event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Open &lt;span class=&quot;keyword&quot;&gt;when&lt;/span&gt; locked -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;dumdum&quot;&lt;/span&gt;; Next (closed locked)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Open -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;squeak&quot;&lt;/span&gt;; Next opened&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Lock -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;click&quot;&lt;/span&gt;; Next (closed &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Unlock -&amp;gt; sound &lt;span class=&quot;string&quot;&gt;&quot;clack&quot;&lt;/span&gt;; Next (closed &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | _ -&amp;gt; Next (closed locked)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Next (closed &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Note, there is a &lt;code&gt;sound&lt;/code&gt; function passed and all states have access to it and this is your context. Additionally &lt;code&gt;closed&lt;/code&gt; state has a &lt;code&gt;locked&lt;/code&gt; ‘property’ and behaves differently depending on the value is this property (cannot be opened when closed, and needs to be unlocked first). You can call it substate if you want.&lt;/p&gt;
&lt;p&gt;What if I don’t like mutable variables and I want my state machine to be an actor / agent? Let’s just wrap it:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; createAgent initial =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    MailboxProcessor.Start (&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; inbox -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;rec&lt;/span&gt; loop state = async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;let!&lt;/span&gt; event = inbox.Receive ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event |&amp;gt; feed state &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            | Stop -&amp;gt; ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            | Next _ &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; next -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;return!&lt;/span&gt; loop next&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        loop initial&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    )&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;So, the full module, already a little bit bloated with helper functions, is:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; StateMachine =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;State&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;Event&lt;/span&gt;&amp;gt; &lt;/span&gt;=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Next &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; (&#39;Event -&amp;gt; State&amp;lt;&#39;Event&amp;gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Stop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; feed state event =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; state &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Stop -&amp;gt; failwith &lt;span class=&quot;string&quot;&gt;&quot;Terminal state reached&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        | Next handler -&amp;gt; event |&amp;gt; handler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;StateMachine&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;&#39;event&lt;/span&gt;&amp;gt;&lt;/span&gt;(initial: State&amp;lt;&#39;event&amp;gt;) =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;mutable&lt;/span&gt; current = initial&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;member&lt;/span&gt; this.Fire event = current &amp;lt;- feed current event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;member&lt;/span&gt; this.IsStopped&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; get () = &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; current &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; | Stop -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt; | _ -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; createMachine initial = StateMachine(initial)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; createAgent initial =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        MailboxProcessor.Start (&lt;span class=&quot;keyword&quot;&gt;fun&lt;/span&gt; inbox -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;rec&lt;/span&gt; loop state = async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;let!&lt;/span&gt; event = inbox.Receive ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; event |&amp;gt; feed state &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                | Stop -&amp;gt; ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                | Next _ &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; next -&amp;gt; &lt;span class=&quot;keyword&quot;&gt;return!&lt;/span&gt; loop next&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            loop initial&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;I can run this now with:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; agent = printfn &lt;span class=&quot;string&quot;&gt;&quot;%s&quot;&lt;/span&gt; |&amp;gt; configureDoor |&amp;gt; StateMachine.createAgent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;agent.Post Lock &lt;span class=&quot;comment&quot;&gt;// click&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;agent.Post Unlock &lt;span class=&quot;comment&quot;&gt;// clack&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;agent.Post Open &lt;span class=&quot;comment&quot;&gt;// squeak&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;agent.Post Close &lt;span class=&quot;comment&quot;&gt;// bang&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;I have to admit. I failed. There is no such thing as State Machine Construction Kit for F#, at least not the one worth releasing, in short, there is just a function:&lt;/p&gt;
&lt;figure class=&quot;highlight fsharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;StateMachineConstructionKit&lt;/span&gt; &lt;/span&gt;= &#39;State -&amp;gt; &#39;Event -&amp;gt; &#39;State&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;but I just can’t put it on GitHub. Maybe &lt;a href=&quot;https://gist.github.com/MiloszKrajewski/b0a2668ab10d8b567b89b1b078c02a2f#file-statemachine-fs&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;?&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: There is a lot of code in this article, as it is repeated and iteratively added. The final version is just 28 line
    
    </summary>
    
    
      <category term="f#" scheme="http://red-green-rewrite.github.io/tags/f/"/>
    
      <category term="state-machine" scheme="http://red-green-rewrite.github.io/tags/state-machine/"/>
    
  </entry>
  
  <entry>
    <title>A perfect square kata</title>
    <link href="http://red-green-rewrite.github.io/2016/05/17/A-perfect-square-kata/"/>
    <id>http://red-green-rewrite.github.io/2016/05/17/A-perfect-square-kata/</id>
    <published>2016-05-17T15:44:09.000Z</published>
    <updated>2016-05-18T09:39:43.749Z</updated>
    
    <content type="html">&lt;p&gt;I was doing some katas on &lt;a href=&quot;http://www.codewars.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CodeWars&lt;/a&gt; recently, and some of them were involving &lt;a href=&quot;https://en.wikipedia.org/wiki/Square_number&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;perfect square numbers&lt;/a&gt;. In short, perfect square number is an integer which square root is also an integer, like 9, 16, 25, and 36.&lt;/p&gt;
&lt;p&gt;Anyway, solutions which got most votes in both categories, &lt;em&gt;best practice&lt;/em&gt; and &lt;em&gt;clever&lt;/em&gt; use:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;IsPerfectSquare&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; number&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Math.Sqrt(number) % &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;This is kind of clever, as .NET (surprisingly) does not provide &lt;code&gt;double Math.Frac(double)&lt;/code&gt;, which would need to be implemented as:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Frac&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt; number&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; number - Math.Floor(number);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;But is it correct (best practice) at all?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Every time you see equals (&lt;code&gt;==&lt;/code&gt;) used with floating point types the red light should go off in your head. Equality and floating point numbers do not work well together. Floating point numbers are usually greater (or equal) than (&lt;code&gt;&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;gt;=&lt;/code&gt;), less (or equal) than (&lt;code&gt;&amp;lt;&lt;/code&gt; or &lt;code&gt;&amp;lt;=&lt;/code&gt;), or within particular range (&lt;code&gt;Math.Abs(x - y) &amp;lt;= Epsilon&lt;/code&gt;), but they are rarely equal (&lt;code&gt;==&lt;/code&gt;). At least you should not rely on that.&lt;/p&gt;
&lt;p&gt;Just try that:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; sum = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Debug.Assert(sum == &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;; i++) sum += &lt;span class=&quot;number&quot;&gt;0.1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Debug.Assert(sum == &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;0.1&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// FAIL! 9.99999999999998 != 10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;So I know that &lt;em&gt;clever&lt;/em&gt; implementation of &lt;code&gt;IsPerfectSquare&lt;/code&gt; is potentially flawed, but as a true wannabe skeptic, I also know that experiment beats theory. I decided to find what is the smallest &lt;em&gt;not so perfect square number&lt;/em&gt; which will deceive this method and force it to provide &lt;em&gt;false positive&lt;/em&gt;.&lt;br&gt;The best bet is a number which is &lt;em&gt;true perfect square plus 1&lt;/em&gt;, so:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;IsPerfectSquare&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; number&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Math.Sqrt(number) % &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Main&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;.MaxValue; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; fake = i*i + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;// fake perfect square&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (IsPerfectSquare(fake)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Console.WriteLine(&lt;span class=&quot;string&quot;&gt;&quot;&amp;#123;0&amp;#125; is the smallest fake perfect square&quot;&lt;/span&gt;, fake);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…and we have an answer in below 3s:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;4503599627370497 is the smallest fake perfect square&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;which is &lt;code&gt;67108864^2 + 1&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;How can we implement &lt;code&gt;IsPerfectSquare&lt;/code&gt; properly then?&lt;/p&gt;
&lt;p&gt;For square roots in integer domain we should probably use &lt;a href=&quot;http://stackoverflow.com/questions/1100090/looking-for-an-efficient-integer-square-root-algorithm-for-arm-thumb2&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;dedicated algorithm&lt;/a&gt; but because this is outside of the scope here (and outside the scope of this kata, I suppose) we need to think how to make &lt;code&gt;Math.Sqrt(...)&lt;/code&gt; work for us.&lt;/p&gt;
&lt;p&gt;We need to bring the equality test back to integer domain. So, even if we use floating point numbers to calculate square root, we will perform the test itself using integers.&lt;/p&gt;
&lt;p&gt;Let’s get the integer (rounded) “square root candidate” first:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; root = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)Math.Sqrt(number);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…and then test if it is really is a square root of given number:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; root*root == number;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;That’s it. Not much more code. There was really no reason to sacrifice correctness for “cleverness”.&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;IsPerfectSquare&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; number&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; root = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)Math.Sqrt(number);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; root*root == number;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;As a bonus we can also check if rounding might be a problem leading to &lt;em&gt;false negatives&lt;/em&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; max = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;.MaxValue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Debug.Assert((&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)Math.Sqrt(max*max) == max); &lt;span class=&quot;comment&quot;&gt;// SUCCESS!&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…and it (most likely) won’t.&lt;br&gt;Of course, this approach will stop working at some point:&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; number = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BigInteger(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;.MaxValue);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; square = number*number;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; root = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BigInteger(Math.Sqrt((&lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt;)square));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Debug.Assert(root == number); &lt;span class=&quot;comment&quot;&gt;// FAIL!&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;…but that’s different story.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;I was doing some katas on &lt;a href=&quot;http://www.codewars.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CodeWars&lt;/a&gt; recently, and some of them were 
    
    </summary>
    
    
      <category term="kata" scheme="http://red-green-rewrite.github.io/tags/kata/"/>
    
      <category term="c#" scheme="http://red-green-rewrite.github.io/tags/c/"/>
    
  </entry>
  
</feed>
